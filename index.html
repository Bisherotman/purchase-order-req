    // --- Helper to render order items for admin details ---
    function renderOrderItemsEdit(container, items, tracking) {
      if (!Array.isArray(items) || items.length === 0) {
        container.innerHTML = '<div class="muted">ูุง ุชูุฌุฏ ุฃุตูุงู.</div>';
        return;
      }
      let html = `<table class="table-like"><thead><tr><th>#</th><th>ููุฏ ุงูุตูู</th><th>ุงููููุฉ</th><th>ุณุนุฑ ุงูุจูุน</th><th>ููุน ุงูุดุญู</th></tr></thead><tbody>`;
      items.forEach((it, i) => {
        html += `<tr><td>${i+1}</td><td>${it.itemCode||''}</td><td>${it.quantity||''}</td><td>${typeof it.price==='number'?it.price.toFixed(2):it.price||''}</td><td>${it.shippingType||''}</td></tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="ุจูุงุจุฉ ุชุณุฌูู ูุฅุฏุงุฑุฉ ุทูุจุงุช ุงูุดุฑุงุก ููุณู ุงููุดุงุฑูุน โ ุดุฑูุฉ ุจูุช ุงูุฅุจุงุก">
  <title>ุจูุงุจุฉ ุทูุจุงุช ุงูุดุฑุงุก | ุงููุดุงุฑูุน</title>


  <!-- ุฃููููุฉ ุงููููุน -->
  <link rel="icon" href="img/pagelogo.png" type="image/png" />


  <!-- ููู ุงูุชูุณููุงุช ุงูุฃุณุงุณู -->
  <link rel="stylesheet" href="style.css">


  <!-- ุฎุทูุท -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Tajawal:wght@400;600;700&display=swap"
    rel="stylesheet">
</head>


<body class="auth-out">


  <header>
    <nav class="nav">
      <a class="brand" href="#/login" id="brandLink">
        <img src="img/pagelogo.png" alt="Bayt Alebaa Logo" />
      </a>
      <div class="title">
        <span class="ar">ุจูุงุจุฉ ุทูุจุงุช ุงูุดุฑุงุก ููุณู ุงููุดุงุฑูุน</span>
        <span class="en">Projects Department Purchase Order Portal</span>
      </div>
      <div class="navlinks" id="navLinks">
        <a href="#/new" data-auth="user" style="display:none">ุทูุจ ุฌุฏูุฏ</a>
        <a href="#/my" data-auth="user" style="display:none">ุทูุจููุงุชู</a>
        <a href="#/admin" data-auth="admin" style="display:none">ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</a>
        <a href="#/login" id="sessionBtn">ุฏุฎูู</a>
      </div>
    </nav>
  </header>

  <main class="container">

    <!-- LOGIN -->
    <section id="view-login" class="view active">
      <div class="card">
        <h2>ุชุณุฌูู ุงูุฏุฎูู</h2>
        <form id="loginForm">
          <label for="loginEmail">ุงูุฅูููู</label>
          <div class="input-wrap">
            <input id="loginEmail" type="email" placeholder="example@baytalebaa.com" inputmode="email"
              autocomplete="username" />
            <button type="button" id="clearEmail" class="input-clear">โ</button>
          </div>

          <label for="loginPassword" style="margin-top:14px">ูููุฉ ุงููุฑูุฑ</label>
          <div class="pwd-wrap input-wrap">
            <input id="loginPassword" type="password" required placeholder="โขโขโขโขโขโขโขโข" />
            <button type="button" class="pwd-toggle" id="togglePwd" aria-label="ุฅุธูุงุฑ/ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ">๐๏ธ</button>
            <button type="button" class="pwd-clear" id="clearPwd" aria-label="ูุณุญ ูููุฉ ุงููุฑูุฑ">โ</button>
          </div>

          <label style="display:flex;gap:8px;align-items:center;margin-top:10px;font-weight:400">
            <input id="rememberEmail" type="checkbox" style="width:18px;height:18px" />
            <span class="helper">ุชุฐููุฑ ุงูุฅูููู</span>
          </label>

          <button type="submit" id="loginBtn" class="btn-strong" style="margin-top:10px">ุฏุฎูู</button>
          <div id="loginMsg" class="msg"></div>
          <div class="helper">* ุฅูุดุงุก ุงูุญุณุงุจุงุช ูุชู ุนุจุฑ ุงูุฅุฏุงุฑุฉ ููุท.</div>
        </form>
      </div>
    </section>

    <!-- NEW ORDER -->
    <section id="view-new" class="view">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>ุชุณุฌูู ุทูุจ ุดุฑุงุก</h2>
          <div class="helper" id="whoami"></div>
        </div>

        <!-- ูุนูููุงุช ุงููุดุฑูุน -->
        <div class="section-box">ูุนูููุงุช ุงููุดุฑูุน</div>
        <div class="row">
          <div>
            <label for="projectName">ุงุณู ุงููุดุฑูุน</label>
            <input id="projectName" type="text" placeholder="...ูุดุฑูุน ุฃุจุฑุงุฌ" required />
          </div>
          <div>
            <label for="customerName">ุงุณู ุงูุนููู</label>
            <input id="customerName" type="text" placeholder="...ุงุณู ุงูุนููู" required />
          </div>
        </div>

        <!-- ุงูุฃุตูุงู -->
        <div class="section-box">ุงูุฃุตูุงู</div>
        <div class="items-head">
          <button type="button" id="addItemBtn" class="add-item">+ ุฅุถุงูุฉ ุตูู</button>
        </div>
        <div id="itemsWrap">
          <!-- ูุชู ุชูููุฏ ุงูุฃุตูุงู ููุง ุนุจุฑ JavaScript -->
        </div>

        <!-- ุงููุฑููุงุช -->
        <label style="font-weight:700; display:block; margin-top:14px;">
          ุฑูุงุจุท ุงููุฑููุงุช (ุงุฎุชูุงุฑู โ ุญุฏ ุฃูุตู 3)
        </label>
        <div id="linksWrap"></div>
        <button type="button" id="addLinkBtn" class="add-item">+ ุฅุถุงูุฉ ุฑุงุจุท</button>

        <!-- ุฅุฑุณุงู ุงูุทูุจ -->
        <button type="button" id="submitOrder" class="btn-strong" style="margin-top:10px;">
          ุฅุฑุณุงู ุงูุทูุจ
        </button>
        <div id="newMsg" class="msg"></div>
      </div>
    </section>

    <!-- MY ORDERS -->
    <section id="view-my" class="view">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>ุทูุจููุงุชู</h2>
          <div class="helper" id="whoamiMy">โ</div>
        </div>

        <div class="filters">
          <input id="mySearch" class="chip-input" placeholder="ุงุจุญุซ ุจุฑูู ุงูุชุชุจูุนุ ููุฏ ุงูุตููุ ุงุณู ุงููุดุฑูุน ุฃู ุงูุนููู" />

          <select id="myFilterStatus" class="chip-select" title="ุงูุญุงูุฉ">
            <option value="">ูู ุงูุญุงูุงุช</option>
            <option value="created">ุฌุฏูุฏ</option>
            <option value="ordered">ุชู ุงูุทูุจ ูู ุงููุตูุน</option>
            <option value="shipped">ุชู ุงูุดุญู</option>
            <option value="delivered">ูุตูุช</option>
          </select>

          <select id="mySort" class="chip-select" title="ุงูุชุฑุชูุจ">
            <option value="createdAt_desc">ุงูุฃุญุฏุซ ุฃููุงู</option>
            <option value="createdAt_asc">ุงูุฃูุฏู ุฃููุงู</option>
          </select>
        </div>

        <div id="myTableWrap" class="card" style="padding:0">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ุงูุชุชุจูุน</th>
                  <th>ุงูุตูู</th>
                  <th>ุงููููุฉ</th>
                  <th>ุงูุณุนุฑ</th>
                  <th>ุงููุดุฑูุน</th>
                  <th>ุงูุญุงูุฉ</th>
                  <th>ุงูุชุงุฑูุฎ</th>
                  <th>ุชูุงุตูู</th>
                </tr>
              </thead>
              <tbody id="myOrdersBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="view">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</h2>
          <div class="helper" id="whoamiAdmin">โ</div>
        </div>

        <div class="filters">
          <input id="adminSearch" class="chip-input"
            placeholder="ุงุจุญุซ ุจุฑูู ุงูุชุชุจูุนุ ููุฏ ุงูุตููุ ุงุณู ุงููุดุฑูุน ุฃู ุงูุนููู" />

          <select id="adminFilterBranch" class="chip-select" title="ุงููุฑุน">
            <option value="">ูู ุงููุฑูุน</option>
            <option>Riyadh</option>
            <option>Dammam</option>
            <option>Jeddah</option>
            <option>Makkah</option>
            <option>Madina</option>
            <option>HQ</option>
          </select>

          <select id="adminFilterStatus" class="chip-select" title="ุงูุญุงูุฉ">
            <option value="">ูู ุงูุญุงูุงุช</option>
            <option value="created">ุฌุฏูุฏ</option>
            <option value="ordered">ุชู ุงูุทูุจ ูู ุงููุตูุน</option>
            <option value="shipped">ุชู ุงูุดุญู</option>
            <option value="delivered">ูุตูุช</option>
          </select>

          <select id="adminFilterUser" class="chip-select" title="ุงููุณุชุฎุฏู">
            <option value="">ูู ุงููุณุชุฎุฏููู</option>
          </select>

          <select id="adminSort" class="chip-select" title="ุงูุชุฑุชูุจ">
            <option value="createdAt_desc">ุงูุฃุญุฏุซ ุฃููุงู</option>
            <option value="createdAt_asc">ุงูุฃูุฏู ุฃููุงู</option>
          </select>
        </div>

        <div id="adminTableWrap" class="card" style="padding:0">
          <div class="table-wrap">
            <table id="ordersTable">
              <thead>
                <tr>
                  <th>ุฑูู</th>
                  <th>ุงูุชุงุฑูุฎ</th>
                  <th>ุงููุดุฑูุน</th>
                  <th>ุงููุณุชุฎุฏู</th>
                  <th>ุงูุญุงูุฉ</th>
                  <th>ุงููุจูุบ</th>
                  <th>ุชูุงุตูู</th>
                </tr>
              </thead>
              <tbody id="adminOrdersBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main> <!-- /container -->

  <footer style="text-align:center; padding:12px; font-size:13px; color:#999">
    &copy; 2025 ุดุฑูุฉ ุจูุช ุงูุฅุจุงุก โ ุฌููุน ุงูุญููู ูุญููุธุฉ
  </footer>

  <!-- ููุฏุงู ุชูุงุตูู ุงูุทูุจ (ููุฃุฏููู) -->
  <div id="orderModal" class="modal" hidden>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="orderModalTitle">
      <header class="modal__header">
        <h3 id="orderModalTitle">ุชูุงุตูู ุงูุทูุจ</h3>
        <button class="modal__close" aria-label="ุฅุบูุงู">ร</button>
      </header>
      <div class="modal__body">
        <div class="meta">
          <div><strong>ุฑูู ุงูุทูุจ:</strong> <span id="m_id"></span></div>
          <div><strong>ุงูุชุงุฑูุฎ:</strong> <span id="m_date"></span></div>
          <div><strong>ุงููุดุฑูุน:</strong> <span id="m_project"></span></div>
          <div><strong>ุงููุณุชุฎุฏู:</strong> <span id="m_user"></span></div>
          <div><strong>ุงูุญุงูุฉ:</strong> <span id="m_status"></span></div>
          <div><strong>ุงููุจูุบ:</strong> <span id="m_total"></span></div>
        </div>
        <h4>ุงูุฃุตูุงู</h4>
        <div id="m_items" class="items"></div>
      </div>
      <footer class="modal__footer">
        <button class="btn" data-action="print">ุทุจุงุนุฉ</button>
        <button class="btn btn-primary modal__close">ุฅุบูุงู</button>
      </footer>
    </div>
  </div>

  <!-- ุชูุงุตูู/ุทุจุงุนุฉ ูุทูุจุงุชู (ุงูููุฏุงู ุงููุฏูู ูุฏููุ ุฃุจูููุงู ููุง ูู) -->
  <div id="detailsModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="modal-card printable">
      <div class="modal-header">
        <div class="inv-brand">
          <img src="img/pagelogo.png" alt="logo">
          <div class="inv-title">ูููุฐุฌ ุทูุจ ุดุฑุงุก</div>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn-strong" id="printDetailsBtn" style="padding:8px 12px;border-radius:10px">ุทุจุงุนุฉ</button>
          <button class="close-x" id="closeDetails">โ</button>
        </div>
      </div>
      <div id="detailsBody" class="t-small"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

  <script>
    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCP29UC4BnT4aJ9pEc4HeV3LGEpylVaSMg",
      authDomain: "purchase-order-req.firebaseapp.com",
      projectId: "purchase-order-req",
      storageBucket: "purchase-order-req.appspot.com",
      messagingSenderId: "72898448492",
      appId: "1:72898448492:web:33a0ec622cbcae47e11c49"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* ---------- helpers / routing ---------- */
    const $ = (s) => document.querySelector(s);
    const routes = { "#/login": "view-login", "#/new": "view-new", "#/my": "view-my", "#/admin": "view-admin" };
    const navLinks = $("#navLinks");
    const sessionBtn = $("#sessionBtn");
    // === Gregorian date formatter (Arabic UI) ===
    const AR_GREG = 'ar-SA-u-ca-gregory-nu-latn';
    function fmtDate(ts, { withTime = false } = {}) {
      if (!ts?.toDate) return '';
      const d = ts.toDate();
      try {
        return withTime
          ? d.toLocaleString(AR_GREG, { dateStyle: 'medium', timeStyle: 'short' })
          : d.toLocaleDateString(AR_GREG, { dateStyle: 'medium' });
      } catch {
        // ุงุญุชูุงุท ูู ูุชุตูุญ ูุฏูู ูุง ูุฏุนู ุงูุงูุชุฏุงุฏ
        return withTime
          ? d.toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' })
          : d.toLocaleDateString('en-GB', { dateStyle: 'medium' });
      }
    }


    function setActive(hash) { navLinks.querySelectorAll("a").forEach(a => a.classList.toggle("active", a.getAttribute("href") == hash)); }
    function showMsg(el, text, type = "success") { el.textContent = text; el.className = "msg " + type; el.style.display = "block"; }
    function hideMsg(el) { el.style.display = "none"; }
    function showView(id) { document.querySelectorAll(".view").forEach(v => v.classList.remove("active")); document.getElementById(id).classList.add("active"); window.scrollTo({ top: 0, behavior: "smooth" }); }

    function route() {
      const h = location.hash || "#/login";
      if (!currentUser && h !== "#/login") { location.hash = "#/login"; setActive("#/login"); showView("view-login"); return; }
      if (!canSeeAdmin && h === "#/admin") { location.hash = "#/new"; }
      const target = routes[location.hash] || "view-login";
      setActive(location.hash);
      showView(target);
    }
    window.addEventListener("hashchange", route);


    /* ---------- state ---------- */
    const loginForm = $("#loginForm"), loginMsg = $("#loginMsg"), loginBtn = $("#loginBtn");
    const whoami = $("#whoami"), whoamiMy = $("#whoamiMy"), whoamiAdmin = $("#whoamiAdmin");
    let currentUser = null, userProfile = null, canSeeAdmin = false, isAdmin = false;

    /* ---------- remember email + toggle/clear pwd & email ---------- */
    const rememberCk = $("#rememberEmail");
    const savedEmail = localStorage.getItem("savedEmail");
    if (savedEmail) { $("#loginEmail").value = savedEmail; rememberCk.checked = true; showEmailClearIfNeeded(); }
    function showEmailClearIfNeeded() {
      const v = $("#loginEmail").value.trim();
      $("#clearEmail").style.display = v ? "flex" : "none";
    }
    $("#loginEmail").addEventListener("input", showEmailClearIfNeeded);
    $("#clearEmail").onclick = () => { $("#loginEmail").value = ""; $("#loginEmail").focus(); showEmailClearIfNeeded(); };

    function showPwdButtonsIfNeeded() {
      const v = $("#loginPassword").value;
      const has = v && v.length > 0;
      $("#togglePwd").style.display = has ? "flex" : "none";
      $("#clearPwd").style.display = has ? "flex" : "none";
    }
    $("#togglePwd").onclick = () => {
      const f = $("#loginPassword");
      const show = (f.type === "password");
      f.type = show ? "text" : "password";
      $("#togglePwd").textContent = show ? "ุฅุฎูุงุก" : "ุฅุธูุงุฑ";
    };
    $("#loginPassword").addEventListener("input", showPwdButtonsIfNeeded);
    $("#clearPwd").onclick = () => { $("#loginPassword").value = ""; $("#loginPassword").focus(); showPwdButtonsIfNeeded(); };

    /* ---------- MY ORDERS elements ---------- */
    const myBody = $("#myOrdersBody"),
      mySearch = $("#mySearch"),
      myFilterStatus = $("#myFilterStatus"),
      mySort = $("#mySort");

    /* ---------- auth ---------- */
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault(); hideMsg(loginMsg);
      loginBtn.classList.add("loading");
      const email = $("#loginEmail").value.trim(), pass = $("#loginPassword").value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        if (rememberCk.checked) localStorage.setItem("savedEmail", email);
        else localStorage.removeItem("savedEmail");
        showMsg(loginMsg, "ุชู ุชุณุฌูู ุงูุฏุฎูู.", "success");
      } catch (err) {
        showMsg(loginMsg, "ุฎุทุฃ: " + (err.message || err), "error");
      } finally {
        loginBtn.classList.remove("loading");
      }
    });
    sessionBtn.addEventListener("click", (e) => { if (currentUser) { e.preventDefault(); auth.signOut(); } });

    function displayNameOrEmail(u, profile) {
      return (profile && profile.name) ? profile.name : (u.displayName || u.email);
    }

    /* ุดุนุงุฑ โ ุตูุญุฉ ููุงุณุจุฉ */
    document.getElementById("brandLink").addEventListener("click", (e) => {
      e.preventDefault();
      if (currentUser) { location.hash = "#/new"; }
      else { location.hash = "#/login"; }
    });

    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      document.body.classList.toggle('auth-out', !user);
      document.body.classList.toggle('auth-in', !!user);

      if (!user) {
        userProfile = null; canSeeAdmin = false;
        navLinks.querySelectorAll("[data-auth]").forEach(a => a.style.display = "none");
        sessionBtn.textContent = "ุฏุฎูู"; sessionBtn.classList.remove("ghost");
        sessionBtn.setAttribute("href", "#/login");
        if (myUnsub) { myUnsub(); myUnsub = null; }
        if (location.hash !== "#/login") location.hash = "#/login";
        showView("view-login"); setActive("#/login");
        return;
      }

      const snap = await db.collection("users").doc(user.uid).get();
      if (!snap.exists) { showMsg(loginMsg, "ุญุณุงุจู ุบูุฑ ูููุฃ. ุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ ูุฅุณูุงุฏ ูุฑุน ูู.", "error"); await auth.signOut(); return; }
      userProfile = snap.data(); canSeeAdmin = !!userProfile.isAdmin || userProfile.branch === "HQ";

      const badge = `ูุฑุญุจุงูุ ${displayNameOrEmail(user, userProfile)} โ ุงููุฑุน: ${userProfile.branch}${canSeeAdmin ? ' โ ุฅุฏุงุฑุฉ' : ''}`;
      $("#whoami").textContent = badge; $("#whoamiMy").textContent = badge; $("#whoamiAdmin").textContent = badge;

      navLinks.querySelectorAll("[data-auth]").forEach(a => {
        const t = a.dataset.auth; a.style.display = (t === "user") ? "" : (canSeeAdmin ? "" : "none");
      });
      sessionBtn.textContent = "ุฎุฑูุฌ"; sessionBtn.setAttribute("href", "#/login");

      if (location.hash === "#/login" || !location.hash) location.hash = "#/new";
      route();
      subscribeMyOrders();
      if (canSeeAdmin) loadAdminOrders();
    });

    /* ---------- tracking / counters ---------- */
    const branchCodes = { Riyadh: "RUH", Dammam: "DMM", Jeddah: "JED", Makkah: "MKK", Madina: "MED", HQ: "HQ" };
    const pad5 = (n) => String(n).padStart(5, "0");

    /* ---------- multi items UI ---------- */
    const itemsWrap = $("#itemsWrap");
    const addItemBtn = $("#addItemBtn");
    function makeItemRow(values = {}) {
      const row = document.createElement("div");
      row.className = "item-row";
      row.innerHTML = `
<input type="text" class="it-code" placeholder="ููุฏ ุงูุตูู" value="${values.itemCode || ""}">
<input type="number" class="it-qty" min="1" step="1" placeholder="ุงููููุฉ" value="${values.quantity || ""}">
<input type="number" class="it-price" min="0" step="0.01" placeholder="ุณุนุฑ ุงูุจูุน" value="${values.price || ""}">
<select class="it-ship" required>
<option value="">ุงุฎุชุฑ ููุน ุงูุดุญู</option>
<option value="Sea freight">Sea freight</option>
<option value="DHL freight">DHL freight</option>
<option value="Air freight">Air freight</option>
</select>
<button type="button" class="remove">๐</button>`;
      row.querySelector(".remove").onclick = () => row.remove();
      return row;
    }
    function ensureAtLeastOneRow() { if (!itemsWrap.children.length) { itemsWrap.appendChild(makeItemRow()); } }
    addItemBtn.onclick = () => itemsWrap.appendChild(makeItemRow());

    /* ---------- links UI ---------- */
    const linksWrap = $("#linksWrap");
    const addLinkBtn = $("#addLinkBtn");
    function makeLinkRow(values = {}) {
      const r = document.createElement("div");
      r.className = "link-row";
      r.innerHTML = `
<input class="ln-name" placeholder="ุงุณู ุงููุฑูู (ูุซุงู: ุนุฑุถ ุณุนุฑ)" value="${values.name || ""}">
<input class="ln-url" placeholder="https://example.com/file.pdf" value="${values.url || ""}">
<button type="button" class="remove">๐</button>`;
      r.querySelector(".remove").onclick = () => { r.remove(); if (linksWrap.children.length < 3) addLinkBtn.disabled = false; };
      return r;
    }
    addLinkBtn.onclick = () => { if (linksWrap.children.length >= 3) return; linksWrap.appendChild(makeLinkRow()); if (linksWrap.children.length >= 3) addLinkBtn.disabled = true; };

    /* ---------- new order ---------- */
    const newMsg = $("#newMsg");
    const submitOrderBtn = $("#submitOrder");
    submitOrderBtn.addEventListener("click", async () => {
      hideMsg(newMsg);
      if (!currentUser || !userProfile) { showMsg(newMsg, "ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู.", "error"); return; }

      const projectName = $("#projectName").value.trim();
      const customerName = $("#customerName").value.trim();

      const items = [...itemsWrap.querySelectorAll(".item-row")].map(r => ({
        itemCode: r.querySelector(".it-code").value.trim(),
        quantity: Number(r.querySelector(".it-qty").value),
        price: Number(r.querySelector(".it-price").value),
        shippingType: r.querySelector(".it-ship")?.value || "",
        status: r.querySelector(".it-status")?.value || "created",
        deliveredQty: Number(r.querySelector(".it-delivered")?.value || 0)
      })).filter(x => x.itemCode && x.shippingType && Number.isFinite(x.quantity) && x.quantity > 0 && Number.isFinite(x.price) && x.price >= 0);

      if (items.length === 0) { showMsg(newMsg, "ุฃุถู ุตูููุง ูุงุญุฏูุง ุนูู ุงูุฃูู ุจุดูู ุตุญูุญ.", "error"); return; }
      if (linksWrap.children.length > 3) { showMsg(newMsg, "ูุณููุญ ุจุซูุงุซ ูุฑููุงุช ูุญุฏ ุฃูุตู.", "error"); return; }

      const attachments = [...linksWrap.querySelectorAll(".link-row")].map(r => {
        const name = (r.querySelector(".ln-name").value || "ููู").trim();
        const url = r.querySelector(".ln-url").value.trim();
        return url ? { name, url } : null;
      }).filter(Boolean);

      submitOrderBtn.classList.add("loading"); submitOrderBtn.disabled = true;

      try {
        const branch = userProfile.branch, code = branchCodes[branch] || "UNK";
        const counterRef = db.collection("counters").doc(branch);
        const seq = await db.runTransaction(async (tx) => { const s = await tx.get(counterRef); let next = 1; if (s.exists) next = (s.data().next || 1); tx.set(counterRef, { next: next + 1 }, { merge: true }); return next; });
        const tracking = code + pad5(seq);

        await db.collection("orders").doc(tracking).set({
          tracking, branch, projectName, customerName,
          items, attachments, createdBy: currentUser.uid,
          createdByEmail: currentUser.email || "",
          status: "created",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showMsg(newMsg, `ุชู ุชุณุฌูู ุงูุทูุจ. ุฑูู ุงูุชุชุจูุน: ${tracking}`, "success");
        $("#projectName").value = ""; $("#customerName").value = "";
        itemsWrap.innerHTML = ""; ensureAtLeastOneRow();
        linksWrap.innerHTML = ""; addLinkBtn.disabled = false;

        subscribeMyOrders(); if (canSeeAdmin) loadAdminOrders();

      } catch (err) {
        console.error(err); showMsg(newMsg, "ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฑุณุงู: " + (err.message || err), "error");
      } finally {
        submitOrderBtn.classList.remove("loading"); submitOrderBtn.disabled = false;
      }
    });

    /* ---------- admin expandable orders ---------- */
    // ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุนูุฏ ุชุบููุฑู (ููุฃุฏูู ููุท)
    document.addEventListener("change", (e) => {
      const select = e.target.closest(".order-status-select");
      if (!select) return;

      const tr = select.closest("tr");
      const tracking = tr?.dataset?.tracking;
      const newStatus = select.value;

      if (!tracking || !newStatus) return;

      // ุชุญุฏูุซ ูุญูู ูู adminRows (ุงุฎุชูุงุฑู)
      const order = adminRows.find(o => o.tracking === tracking);
      if (order) order.status = newStatus;

      // ุนุฑุถ ุฑุณุงูุฉ ุฃู ุชูููุฐ ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุงุญูุงู)
      console.log(`ุชู ุชุญุฏูุซ ุงูุทูุจ ${tracking} ุฅูู: ${newStatus}`);
    });

    document.addEventListener("click", (e) => {
      const toggleBtn = e.target.closest(".toggle-items");
      if (!toggleBtn) return;
      const tr = toggleBtn.closest("tr");
      const tracking = tr?.dataset?.tracking;
      const container = tr.nextElementSibling?.classList.contains("sub-items-row") ? tr.nextElementSibling : null;


      if (container) {
        container.hidden = !container.hidden;
        toggleBtn.textContent = container.hidden ? "๐ฝ" : "๐ผ";
      } else {
        const newRow = document.createElement("tr");
        newRow.className = "sub-items-row";
        newRow.innerHTML = `<td colspan="100%"><div class="loading">ุฌุงุฑู ุชุญููู ุงูุฃุตูุงู...</div></td>`;
        tr.parentNode.insertBefore(newRow, tr.nextSibling);
        toggleBtn.textContent = "๐ผ";


        const r = (Array.isArray(adminRows) && adminRows.find(x => x.tracking === tracking));
        if (r) {
          const inner = document.createElement("div");
          renderOrderItemsEdit(inner, r.items || [], tracking);
          newRow.innerHTML = `<td colspan="100%"></td>`;
          newRow.firstElementChild.appendChild(inner);
        } else {
          newRow.innerHTML = `<td colspan="100%"><div class="msg error">ุชุนุฐูุฑ ุชุญููู ุงูุฃุตูุงู.</div></td>`;
        }
      }
    });

    /* ---------- table row renderer modification ---------- */
    function renderTableRow(r) {
      const createdAtStr = r.createdAt || "-";
      const userLabel = r.user || "-";
      const priceFirst = r.total;
      return `
<tr data-id="${r.tracking}">
<td>${r.tracking}</td>
<td>${createdAtStr}</td>
<td>${r.projectName || "-"}</td>
<td>${userLabel}</td>
<td>
<select class="status-dropdown" data-id="${r.tracking}">
<option value="created" ${r.status === 'created' ? 'selected' : ''}>ุฌุฏูุฏ</option>
<option value="ordered" ${r.status === 'ordered' ? 'selected' : ''}>ุชู ุงูุทูุจ ูู ุงููุตูุน</option>
<option value="shipped" ${r.status === 'shipped' ? 'selected' : ''}>ุชู ุงูุดุญู</option>
<option value="partial" ${r.status === 'partial' ? 'selected' : ''}>ูุตูุช ุฌุฒุฆูุงู</option>
<option value="delivered" ${r.status === 'delivered' ? 'selected' : ''}>ูุตูุช ุจุงููุงูู</option>
</select>
</td>
<td>${(typeof priceFirst === "number") ? priceFirst.toFixed(2) : priceFirst}</td>
<td style="white-space: nowrap; text-align: left;">
<button type="button" class="toggle-items btn-sm" title="ุนุฑุถ ุงูุชูุงุตูู" style="margin-inline-end: 6px;">๐ฝ</button>
<button type="button" class="btn-details btn-sm" title="ุทุจุงุนุฉ ุงูุทูุจ" data-id="${r.tracking}">๐จ๏ธ</button>
</td>
</tr>`;
    }

    /* ---------- MY ORDERS (Realtime) + details/print ---------- */

    function renderMyRow(r) {
      const createdAtStr = r.createdAt || "-";
      const priceFirst = r.total ?? "";

      return `
    <tr data-id="${r.tracking}">
      <td>${r.tracking}</td>
      <td>${createdAtStr}</td>
      <td>${r.projectName || "-"}</td>
      <td>${typeof priceFirst === "number" ? priceFirst.toFixed(2) : priceFirst}</td>
      <td>
        <button type="button" class="toggle-items btn-sm" title="ุนุฑุถ ุงูุชูุงุตูู" style="margin-inline-end:6px;">โพ</button>
        <button type="button" class="btn-details btn-sm" title="ุจุทุงูุฉ ุงูุทูุจ" data-id="${r.tracking}">๐๏ธ</button>
      </td>
    </tr>
  `;
    }

    let myUnsub = null, myRows = [];
    function subscribeMyOrders() {
      if (myUnsub) { myUnsub(); myUnsub = null; }
      if (!currentUser) return;
      const q = db.collection("orders").where("createdBy", "==", currentUser.uid);
      myUnsub = q.onSnapshot((snap) => {
        myRows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        console.log('My Orders fetched:', myRows); // Debug log
        renderMy(myRows);
      },
        (err) => { console.error(err); showMsg(document.getElementById("newMsg"), "ุชุนุฐูุฑ ุชุญููู ุทูุจุงุชู: " + (err.message || err), "error"); });
    }
    const myTableBody = $("#myOrdersBody");
    function renderMy(rows) {
      // ููุชุฑ ุงูุญุงูุฉ
      const selectedStatus = (myFilterStatus?.value || "").trim();
      if (selectedStatus) {
        rows = rows.filter(r => (r.status || "") === selectedStatus);
      }

      // ุงูุจุญุซ
      const term = (mySearch.value || "").trim().toLowerCase();
      rows = rows.filter(r => {
        if (!term) return true;
        const inTracking = (r.tracking || "").toLowerCase().includes(term);
        const inProj = (r.projectName || "").toLowerCase().includes(term);
        const inCust = (r.customerName || "").toLowerCase().includes(term);
        const inItems = (r.items || []).some(it => (it.itemCode || "").toLowerCase().includes(term));
        return inTracking || inProj || inCust || inItems;
      });

      // ุงูุชุฑุชูุจ
      rows.sort((a, b) => (mySort.value === "createdAt_desc"
        ? (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0)
        : (a.createdAt?.toMillis?.() || 0) - (b.createdAt?.toMillis?.() || 0)));

      // ุงูุนุฑุถ
      myTableBody.innerHTML = rows.map(r => {
        const items = r.items || [];
        const firstCode = items[0]?.itemCode || "";
        const extra = items.length > 1 ? ` (+${items.length - 1})` : "";
        const qtySum = items.reduce((s, x) => s + (x.quantity || 0), 0);
        const priceFirst = items.length ? (items[0].price ?? "") : "";
        const createdAtStr = fmtDate(r.createdAt, { withTime: true });

        return `
      <tr>
        <td><strong>${r.tracking}</strong></td>
        <td>${firstCode}${extra}</td>
        <td>${qtySum}</td>
        <td>${(typeof priceFirst === "number") ? priceFirst.toFixed(2) : priceFirst}</td>
        <td>${r.projectName || "-"}</td>
        <td><span class="status ${statusClass(r.status)}">${statusLabel(r.status)}</span></td>
        <td>${createdAtStr}</td>
        <td><button type="button" class="btn-strong" data-open="${r.tracking}" style="padding:6px 10px;border-radius:10px">ุชูุงุตูู</button></td>
      </tr>`;
      }).join("");
    }
    //document.querySelectorAll('[data-open]').forEach(btn=>{ btn.onclick = ()=> openDetails(btn.dataset.open); });
    mySearch.addEventListener("input", () => renderMy(myRows));
    mySort.addEventListener("change", () => renderMy(myRows));
    myFilterStatus.addEventListener("change", () => renderMy(myRows));

    /* ---------- ADMIN (ุจุญุซ ููุญุณูู + ุฒุฑ ุงูุชูุงุตูู) ---------- */
    const adminBody = $("#adminOrdersBody"),
      adminSearch = $("#adminSearch"),
      adminFilterBranch = $("#adminFilterBranch"),
      adminFilterStatus = $("#adminFilterStatus"),
      adminFilterUser = $("#adminFilterUser"),
      adminSort = $("#adminSort");
    let usersById = {}; // uid -> {name, email, ...}

    let adminRows = [];
    async function loadAdminOrders() { // NEW
      if (!canSeeAdmin) return;

      const [ordersSnap, usersSnap] = await Promise.all([
        db.collection("orders").get(),
        db.collection("users").get()
      ]);

      usersById = {};
      usersSnap.forEach(d => usersById[d.id] = d.data() || {});

      adminRows = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      populateAdminUsers(adminRows);
      renderAdmin();
    }

    function populateAdminUsers(rows) { // NEW
      const map = new Map(); // uid -> label
      rows.forEach(r => {
        const uid = (r.createdBy || "").trim();
        if (!uid) return;
        const label = (usersById[uid]?.name || usersById[uid]?.email || uid);
        map.set(uid, label);
      });

      adminFilterUser.innerHTML =
        `<option value="">ูู ุงููุณุชุฎุฏููู</option>` +
        [...map.entries()]
          .sort((a, b) => a[1].localeCompare(b[1], 'ar'))
          .map(([uid, label]) => `<option value="${uid}">${label}</option>`)
          .join("");
    }

    function renderAdmin() { // NEW
      const term = (adminSearch.value || "").trim().toLowerCase();
      const fb = (adminFilterBranch.value || "");
      const fs = (adminFilterStatus.value || "");
      const fu = (adminFilterUser.value || ""); // โ UID
      const sort = (adminSort.value || "createdAt_desc");

      let rows = adminRows.filter(r => {
        if (fb && r.branch !== fb) return false;
        if (fs && (r.status || "") !== fs) return false;
        if (fu && (r.createdBy || "") !== fu) return false;

        if (!term) return true;
        const inTracking = (r.tracking || "").toLowerCase().includes(term);
        const inProj = (r.projectName || "").toLowerCase().includes(term);
        const inCust = (r.customerName || "").toLowerCase().includes(term);
        const inItems = (r.items || []).some(it => (it.itemCode || "").toLowerCase().includes(term));
        const inUserName = (usersById[r.createdBy]?.name || "").toLowerCase().includes(term);
        const inUserMail = (usersById[r.createdBy]?.email || "").toLowerCase().includes(term);
        return inTracking || inProj || inCust || inItems || inUserName || inUserMail;
      });

      rows.sort((a, b) => sort === "createdAt_desc"
        ? (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0)
        : (a.createdAt?.toMillis?.() || 0) - (b.createdAt?.toMillis?.() || 0));

      adminBody.innerHTML = rows.map(r => renderTableRow({
        ...r,
        user: usersById[r.createdBy]?.name || usersById[r.createdBy]?.email || r.createdBy,
        createdAt: fmtDate(r.createdAt),
        total: r.items?.[0]?.price ?? ""
      })).join("");


      adminSearch.addEventListener("input", renderAdmin);
      adminFilterBranch.addEventListener("change", renderAdmin);
      adminFilterStatus.addEventListener("change", renderAdmin);
      adminFilterUser.addEventListener("change", renderAdmin);
      adminSort.addEventListener("change", renderAdmin);

      // โ ุชุญุฏูุซ ุงูุญุงูุฉ ูุจุงุดุฑุฉ ุนูุฏ ุชุบููุฑูุง
      document.addEventListener("change", async (e) => {
        const select = e.target.closest(".order-status-select");
        if (!select) return;

        const tracking = select.dataset.tracking;
        const newStatus = select.value;

        if (!tracking || !newStatus) return;

        select.disabled = true;
        select.style.opacity = 0.6;

        try {
          await db.collection("orders").doc(tracking).update({ status: newStatus });

          const row = adminRows.find(r => r.tracking === tracking);
          if (row) row.status = newStatus;

          select.style.border = "2px solid #6c1d2c";
          setTimeout(() => {
            select.style.border = "";
          }, 1000);
        } catch (err) {
          alert("ูุดู ุงูุชุญุฏูุซ: " + (err.message || err));
        } finally {
          select.disabled = false;
          select.style.opacity = 1;
        }
      });

      function statusLabel(s) { return { created: "ุฌุฏูุฏ", ordered: "ุชู ุงูุทูุจ ูู ุงููุตูุน", shipped: "ุชู ุงูุดุญู", delivered: "ูุตูุช" }[s] || s; }
      function statusClass(s) { return { created: "s-created", ordered: "s-ordered", shipped: "s-shipped", delivered: "s-delivered" }[s] || "s-created"; }
    }


      // โ ุชุณุฌูู ุญุฏุซ ุงูุถุบุท ุนูู ุงูุฃุฒุฑุงุฑ ูุฑุฉ ูุงุญุฏุฉ ููุท
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('[data-open], .btn-details');
        if (!btn) return;
        e.preventDefault();

        const tr = btn.closest('tr');
        const tracking =
          btn.dataset.open ||
          btn.dataset.id ||
          tr?.dataset.id ||
          tr?.cells?.[0]?.textContent?.trim();

        if (!tracking) {
          console.warn('Details: ูุง ููุฌุฏ ุฑูู ุชุชุจูุน');
          return;
        }

        openDetails(tracking); // ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุชูุงุตูู
      });

      // ุฅุบูุงู/ุทุจุงุนุฉ ููุฏุงู ุงูุชูุงุตูู
      (function () {
        const modal = document.getElementById('detailsModal');
        const closeBtn = document.getElementById('closeDetails');
        const printBtn = document.getElementById('printDetailsBtn');

        closeBtn && (closeBtn.onclick = () => modal.classList.remove('show'));
        modal.querySelector('.backdrop')?.addEventListener('click', () => modal.classList.remove('show'));
        printBtn && (printBtn.onclick = () => window.print());
      })();
      // Ensure all opened blocks are closed
    </script>

</body>

</html>
