<tfoot><tr><td colspan="2" class="total">إجمالي الكميات</td><td class="total">${qtySum}</td><td></td></tr></tfoot>
    </table>

    <div style="margin-top:10px">
      <b>المرفقات:</b>
      ${attachHtml}
    </div>
  `;
  modal.classList.add("show");
}
closeDetails.onclick = ()=> modal.classList.remove("show");
modal.querySelector(".backdrop").onclick = ()=> modal.classList.remove("show");
printBtn.onclick = ()=> window.print();

/* ---------- ADMIN (بحث مُحسّن + زر التفاصيل) ---------- */
const adminBody=$("#adminOrdersBody"), adminSearch=$("#adminSearch"), adminFilterBranch=$("#adminFilterBranch");
let adminRows=[];
async function loadAdminOrders(){
  if(!canSeeAdmin) return;
  const snap=await db.collection("orders").get();
  adminRows=snap.docs.map(d=>({id:d.id,...d.data()}));
  renderAdmin();
}
function renderAdmin(){
  const term=(adminSearch.value||"").toLowerCase();
  const fb=adminFilterBranch.value;

  let rows = adminRows.filter(r=>{
    if (fb && r.branch!==fb) return false;
    if (!term) return true;
    const inItems = (r.items||[]).some(it => (it.itemCode||"").toLowerCase().includes(term));
    return r.tracking.toLowerCase().includes(term) ||
           (r.projectName||"").toLowerCase().includes(term) ||
           (r.customerName||"").toLowerCase().includes(term) ||
           inItems;
  });
  rows.sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));

  adminBody.innerHTML=rows.map(r=>{
    const items=r.items||[];
    const firstCode=items[0]?.itemCode || "";
    const extra=items.length>1 ?  (+${items.length-1}) : "";
    const qtySum=items.reduce((s,x)=>s+(x.quantity||0),0);
    const priceFirst=items.length ? (items[0].price ?? "") : "";
    return `
      <tr>
        <td>${r.branch}</td>
        <td><strong>${r.tracking}</strong></td>
        <td>${firstCode}${extra}</td>
        <td>${qtySum}</td>
        <td>${(typeof priceFirst==="number") ? priceFirst.toFixed(2) : priceFirst}</td>
        <td>${r.projectName||"-"}</td>
        <td><span class="status ${statusClass(r.status)}">${statusLabel(r.status)}</span></td>
        <td style="display:flex;gap:6px;align-items:center">
          <select data-id="${r.tracking}" class="updStatus">
            ${["created","ordered","shipped","delivered"].map(s=>`<option value="${s}" ${r.status===s?"selected":""}>${statusLabel(s)}</option>`).join("")}
          </select>
          <button type="button" class="btn-strong open-details" data-open="${r.tracking}" style="padding:6px 10px;border-radius:10px">تفاصيل</button>
        </td>
      </tr>`;
  }).join("");

  // تغيـير الحالة
  document.querySelectorAll(".updStatus").forEach(sel=>{
    sel.onchange=async(e)=>{
      const id=e.target.dataset.id, val=e.target.value;
      await db.collection("orders").doc(id).update({status:val});
      loadAdminOrders(); subscribeMyOrders();
    };
  });
  // فتح التفاصيل
  adminBody.querySelectorAll(".open-details").forEach(btn=>{
    btn.onclick = ()=> openDetails(btn.dataset.open);
  });
}
adminSearch.addEventListener("input",renderAdmin);
adminFilterBranch.addEventListener("change",renderAdmin);

function statusLabel(s){ return {created:"جديد",ordered:"تم الطلب من المصنع",shipped:"تم الشحن",delivered:"وصلت"}[s] || s; }
function statusClass(s){ return {created:"s-created",ordered:"s-ordered",shipped:"s-shipped",delivered:"s-delivered"}[s] || "s-created"; }

/* ---------- init ---------- */
route();
</script>
</body>
</html>
