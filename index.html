    // --- Helper to render order items for admin details ---
    function renderOrderItemsEdit(container, items, tracking) {
      if (!Array.isArray(items) || items.length === 0) {
        container.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.</div>';
        return;
      }
      let html = `<table class="table-like"><thead><tr><th>#</th><th>ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø´Ø­Ù†</th></tr></thead><tbody>`;
      items.forEach((it, i) => {
        html += `<tr><td>${i+1}</td><td>${it.itemCode||''}</td><td>${it.quantity||''}</td><td>${typeof it.price==='number'?it.price.toFixed(2):it.price||''}</td><td>${it.shippingType||''}</td></tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Ø¨ÙˆØ§Ø¨Ø© ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ â€“ Ø´Ø±ÙƒØ© Ø¨ÙŠØª Ø§Ù„Ø¥Ø¨Ø§Ø¡">
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ | Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</title>


  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
  <link rel="icon" href="img/pagelogo.png" type="image/png" />


  <!-- Ù…Ù„Ù Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ -->
  <link rel="stylesheet" href="style.css">


  <!-- Ø®Ø·ÙˆØ· -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Tajawal:wght@400;600;700&display=swap"
    rel="stylesheet">
</head>


<body class="auth-out">


  <header>
    <nav class="nav">
      <a class="brand" href="#/login" id="brandLink">
        <img src="img/pagelogo.png" alt="Bayt Alebaa Logo" />
      </a>
      <div class="title">
        <span class="ar">Ø¨ÙˆØ§Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
        <span class="en">Projects Department Purchase Order Portal</span>
      </div>
      <div class="navlinks" id="navLinks">
        <a href="#/new" data-auth="user" style="display:none">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</a>
        <a href="#/my" data-auth="user" style="display:none">Ø·Ù„Ø¨Ù€Ù€Ø§ØªÙŠ</a>
        <a href="#/admin" data-auth="admin" style="display:none">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
        <a href="#/login" id="sessionBtn">Ø¯Ø®ÙˆÙ„</a>
      </div>
    </nav>
  </header>

  <main class="container">

    <!-- LOGIN -->
    <section id="view-login" class="view active">
      <div class="card">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <form id="loginForm">
          <label for="loginEmail">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
          <div class="input-wrap">
            <input id="loginEmail" type="email" placeholder="example@baytalebaa.com" inputmode="email"
              autocomplete="username" />
            <button type="button" id="clearEmail" class="input-clear">âœ•</button>
          </div>

          <label for="loginPassword" style="margin-top:14px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <div class="pwd-wrap input-wrap">
            <input id="loginPassword" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
            <button type="button" class="pwd-toggle" id="togglePwd" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">ğŸ‘ï¸</button>
            <button type="button" class="pwd-clear" id="clearPwd" aria-label="Ù…Ø³Ø­ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">âœ•</button>
          </div>

          <label style="display:flex;gap:8px;align-items:center;margin-top:10px;font-weight:400">
            <input id="rememberEmail" type="checkbox" style="width:18px;height:18px" />
            <span class="helper">ØªØ°ÙƒÙ‘Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</span>
          </label>

          <button type="submit" id="loginBtn" class="btn-strong" style="margin-top:10px">Ø¯Ø®ÙˆÙ„</button>
          <div id="loginMsg" class="msg"></div>
          <div class="helper">* Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙŠØªÙ… Ø¹Ø¨Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·.</div>
        </form>
      </div>
    </section>

    <!-- NEW ORDER -->
    <section id="view-new" class="view">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡</h2>
          <div class="helper" id="whoami"></div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ -->
        <div class="section-box">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
        <div class="row">
          <div>
            <label for="projectName">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
            <input id="projectName" type="text" placeholder="...Ù…Ø´Ø±ÙˆØ¹ Ø£Ø¨Ø±Ø§Ø¬" required />
          </div>
          <div>
            <label for="customerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input id="customerName" type="text" placeholder="...Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" required />
          </div>
        </div>

        <!-- Ø§Ù„Ø£ØµÙ†Ø§Ù -->
        <div class="section-box">Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
        <div class="items-head">
          <button type="button" id="addItemBtn" class="add-item">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
        </div>
        <div id="itemsWrap">
          <!-- ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù‡Ù†Ø§ Ø¹Ø¨Ø± JavaScript -->
        </div>

        <!-- Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
        <label style="font-weight:700; display:block; margin-top:14px;">
          Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€“ Ø­Ø¯ Ø£Ù‚ØµÙ‰ 3)
        </label>
        <div id="linksWrap"></div>
        <button type="button" id="addLinkBtn" class="add-item">+ Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·</button>

        <!-- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ -->
        <button type="button" id="submitOrder" class="btn-strong" style="margin-top:10px;">
          Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        </button>
        <div id="newMsg" class="msg"></div>
      </div>
    </section>

    <!-- MY ORDERS -->
    <section id="view-my" class="view">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Ø·Ù„Ø¨Ù€Ù€Ø§ØªÙŠ</h2>
          <div class="helper" id="whoamiMy">â€”</div>
        </div>

        <div class="filters">
          <input id="mySearch" class="chip-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ù‘Ø¹ØŒ ÙƒÙˆØ¯ Ø§Ù„ØµÙ†ÙØŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„" />

          <select id="myFilterStatus" class="chip-select" title="Ø§Ù„Ø­Ø§Ù„Ø©">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="created">Ø¬Ø¯ÙŠØ¯</option>
            <option value="ordered">ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…ØµÙ†Ø¹</option>
            <option value="shipped">ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
            <option value="delivered">ÙˆØµÙ„Øª</option>
          </select>

          <select id="mySort" class="chip-select" title="Ø§Ù„ØªØ±ØªÙŠØ¨">
            <option value="createdAt_desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
            <option value="createdAt_asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
          </select>
        </div>

        <div id="myTableWrap" class="card" style="padding:0">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØªØ¨Ù‘Ø¹</th>
                  <th>Ø§Ù„ØµÙ†Ù</th>
                  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>ØªÙØ§ØµÙŠÙ„</th>
                </tr>
              </thead>
              <tbody id="myOrdersBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="view">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
          <div class="helper" id="whoamiAdmin">â€”</div>
        </div>

        <div class="filters">
          <input id="adminSearch" class="chip-input"
            placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ù‘Ø¹ØŒ ÙƒÙˆØ¯ Ø§Ù„ØµÙ†ÙØŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„" />

          <select id="adminFilterBranch" class="chip-select" title="Ø§Ù„ÙØ±Ø¹">
            <option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
            <option>Riyadh</option>
            <option>Dammam</option>
            <option>Jeddah</option>
            <option>Makkah</option>
            <option>Madina</option>
            <option>HQ</option>
          </select>

          <select id="adminFilterStatus" class="chip-select" title="Ø§Ù„Ø­Ø§Ù„Ø©">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="created">Ø¬Ø¯ÙŠØ¯</option>
            <option value="ordered">ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…ØµÙ†Ø¹</option>
            <option value="shipped">ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
            <option value="delivered">ÙˆØµÙ„Øª</option>
          </select>

          <select id="adminFilterUser" class="chip-select" title="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>
          </select>

          <select id="adminSort" class="chip-select" title="Ø§Ù„ØªØ±ØªÙŠØ¨">
            <option value="createdAt_desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
            <option value="createdAt_asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
          </select>
        </div>

        <div id="adminTableWrap" class="card" style="padding:0">
          <div class="table-wrap">
            <table id="ordersTable">
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù…</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
                  <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>ØªÙØ§ØµÙŠÙ„</th>
                </tr>
              </thead>
              <tbody id="adminOrdersBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main> <!-- /container -->

  <footer style="text-align:center; padding:12px; font-size:13px; color:#999">
    &copy; 2025 Ø´Ø±ÙƒØ© Ø¨ÙŠØª Ø§Ù„Ø¥Ø¨Ø§Ø¡ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
  </footer>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù„Ù„Ø£Ø¯Ù…ÙÙ†) -->
  <div id="orderModal" class="modal" hidden>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="orderModalTitle">
      <header class="modal__header">
        <h3 id="orderModalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
        <button class="modal__close" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      </header>
      <div class="modal__body">
        <div class="meta">
          <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> <span id="m_id"></span></div>
          <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="m_date"></span></div>
          <div><strong>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</strong> <span id="m_project"></span></div>
          <div><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> <span id="m_user"></span></div>
          <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span id="m_status"></span></div>
          <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> <span id="m_total"></span></div>
        </div>
        <h4>Ø§Ù„Ø£ØµÙ†Ø§Ù</h4>
        <div id="m_items" class="items"></div>
      </div>
      <footer class="modal__footer">
        <button class="btn" data-action="print">Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn btn-primary modal__close">Ø¥ØºÙ„Ø§Ù‚</button>
      </footer>
    </div>
  </div>

  <!-- ØªÙØ§ØµÙŠÙ„/Ø·Ø¨Ø§Ø¹Ø© Ù„Ø·Ù„Ø¨Ø§ØªÙŠ (Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ø¯ÙŠÙƒØŒ Ø£Ø¨Ù‚ÙŠÙ†Ø§Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ) -->
  <div id="detailsModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="modal-card printable">
      <div class="modal-header">
        <div class="inv-brand">
          <img src="img/pagelogo.png" alt="logo">
          <div class="inv-title">Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡</div>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn-strong" id="printDetailsBtn" style="padding:8px 12px;border-radius:10px">Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="close-x" id="closeDetails">âœ•</button>
        </div>
      </div>
      <div id="detailsBody" class="t-small"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

  <script>
    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCP29UC4BnT4aJ9pEc4HeV3LGEpylVaSMg",
      authDomain: "purchase-order-req.firebaseapp.com",
      projectId: "purchase-order-req",
      storageBucket: "purchase-order-req.appspot.com",
      messagingSenderId: "72898448492",
      appId: "1:72898448492:web:33a0ec622cbcae47e11c49"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* ---------- helpers / routing ---------- */
    const $ = (s) => document.querySelector(s);
    const routes = { "#/login": "view-login", "#/new": "view-new", "#/my": "view-my", "#/admin": "view-admin" };
    const navLinks = $("#navLinks");
    const sessionBtn = $("#sessionBtn");
    // === Gregorian date formatter (Arabic UI) ===
    const AR_GREG = 'ar-SA-u-ca-gregory-nu-latn';
    function fmtDate(ts, { withTime = false } = {}) {
      if (!ts?.toDate) return '';
      const d = ts.toDate();
      try {
        return withTime
          ? d.toLocaleString(AR_GREG, { dateStyle: 'medium', timeStyle: 'short' })
          : d.toLocaleDateString(AR_GREG, { dateStyle: 'medium' });
      } catch {
        // Ø§Ø­ØªÙŠØ§Ø· Ù„Ùˆ Ù…ØªØµÙØ­ Ù‚Ø¯ÙŠÙ… Ù…Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯
        return withTime
          ? d.toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' })
          : d.toLocaleDateString('en-GB', { dateStyle: 'medium' });
      }
    }


    function setActive(hash) { navLinks.querySelectorAll("a").forEach(a => a.classList.toggle("active", a.getAttribute("href") == hash)); }
    function showMsg(el, text, type = "success") { el.textContent = text; el.className = "msg " + type; el.style.display = "block"; }
    function hideMsg(el) { el.style.display = "none"; }
    function showView(id) { document.querySelectorAll(".view").forEach(v => v.classList.remove("active")); document.getElementById(id).classList.add("active"); window.scrollTo({ top: 0, behavior: "smooth" }); }

    function route() {
      const h = location.hash || "#/login";
      if (!currentUser && h !== "#/login") { location.hash = "#/login"; setActive("#/login"); showView("view-login"); return; }
      if (!canSeeAdmin && h === "#/admin") { location.hash = "#/new"; }
      const target = routes[location.hash] || "view-login";
      setActive(location.hash);
      showView(target);
    }
    window.addEventListener("hashchange", route);


    /* ---------- state ---------- */
    const loginForm = $("#loginForm"), loginMsg = $("#loginMsg"), loginBtn = $("#loginBtn");
    const whoami = $("#whoami"), whoamiMy = $("#whoamiMy"), whoamiAdmin = $("#whoamiAdmin");
    let currentUser = null, userProfile = null, canSeeAdmin = false, isAdmin = false;

    /* ---------- remember email + toggle/clear pwd & email ---------- */
    const rememberCk = $("#rememberEmail");
    const savedEmail = localStorage.getItem("savedEmail");
    if (savedEmail) { $("#loginEmail").value = savedEmail; rememberCk.checked = true; showEmailClearIfNeeded(); }
    function showEmailClearIfNeeded() {
      const v = $("#loginEmail").value.trim();
      $("#clearEmail").style.display = v ? "flex" : "none";
    }
    $("#loginEmail").addEventListener("input", showEmailClearIfNeeded);
    $("#clearEmail").onclick = () => { $("#loginEmail").value = ""; $("#loginEmail").focus(); showEmailClearIfNeeded(); };

    function showPwdButtonsIfNeeded() {
      const v = $("#loginPassword").value;
      const has = v && v.length > 0;
      $("#togglePwd").style.display = has ? "flex" : "none";
      $("#clearPwd").style.display = has ? "flex" : "none";
    }
    $("#togglePwd").onclick = () => {
      const f = $("#loginPassword");
      const show = (f.type === "password");
      f.type = show ? "text" : "password";
      $("#togglePwd").textContent = show ? "Ø¥Ø®ÙØ§Ø¡" : "Ø¥Ø¸Ù‡Ø§Ø±";
    };
    $("#loginPassword").addEventListener("input", showPwdButtonsIfNeeded);
    $("#clearPwd").onclick = () => { $("#loginPassword").value = ""; $("#loginPassword").focus(); showPwdButtonsIfNeeded(); };

    /* ---------- MY ORDERS elements ---------- */
    const myBody = $("#myOrdersBody"),
      mySearch = $("#mySearch"),
      myFilterStatus = $("#myFilterStatus"),
      mySort = $("#mySort");

    /* ---------- auth ---------- */
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault(); hideMsg(loginMsg);
      loginBtn.classList.add("loading");
      const email = $("#loginEmail").value.trim(), pass = $("#loginPassword").value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        if (rememberCk.checked) localStorage.setItem("savedEmail", email);
        else localStorage.removeItem("savedEmail");
        showMsg(loginMsg, "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.", "success");
      } catch (err) {
        showMsg(loginMsg, "Ø®Ø·Ø£: " + (err.message || err), "error");
      } finally {
        loginBtn.classList.remove("loading");
      }
    });
    sessionBtn.addEventListener("click", (e) => { if (currentUser) { e.preventDefault(); auth.signOut(); } });

    function displayNameOrEmail(u, profile) {
      return (profile && profile.name) ? profile.name : (u.displayName || u.email);
    }

    /* Ø´Ø¹Ø§Ø± â†’ ØµÙØ­Ø© Ù…Ù†Ø§Ø³Ø¨Ø© */
    document.getElementById("brandLink").addEventListener("click", (e) => {
      e.preventDefault();
      if (currentUser) { location.hash = "#/new"; }
      else { location.hash = "#/login"; }
    });

    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      document.body.classList.toggle('auth-out', !user);
      document.body.classList.toggle('auth-in', !!user);

      if (!user) {
        userProfile = null; canSeeAdmin = false;
        navLinks.querySelectorAll("[data-auth]").forEach(a => a.style.display = "none");
        sessionBtn.textContent = "Ø¯Ø®ÙˆÙ„"; sessionBtn.classList.remove("ghost");
        sessionBtn.setAttribute("href", "#/login");
        if (myUnsub) { myUnsub(); myUnsub = null; }
        if (location.hash !== "#/login") location.hash = "#/login";
        showView("view-login"); setActive("#/login");
        return;
      }

      const snap = await db.collection("users").doc(user.uid).get();
      if (!snap.exists) { showMsg(loginMsg, "Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…Ù‡ÙŠØ£. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ø¥Ø³Ù†Ø§Ø¯ ÙØ±Ø¹ Ù„Ùƒ.", "error"); await auth.signOut(); return; }
      userProfile = snap.data(); canSeeAdmin = !!userProfile.isAdmin || userProfile.branch === "HQ";

      const badge = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${displayNameOrEmail(user, userProfile)} â€” Ø§Ù„ÙØ±Ø¹: ${userProfile.branch}${canSeeAdmin ? ' â€” Ø¥Ø¯Ø§Ø±Ø©' : ''}`;
      $("#whoami").textContent = badge; $("#whoamiMy").textContent = badge; $("#whoamiAdmin").textContent = badge;

      navLinks.querySelectorAll("[data-auth]").forEach(a => {
        const t = a.dataset.auth; a.style.display = (t === "user") ? "" : (canSeeAdmin ? "" : "none");
      });
      sessionBtn.textContent = "Ø®Ø±ÙˆØ¬"; sessionBtn.setAttribute("href", "#/login");

      if (location.hash === "#/login" || !location.hash) location.hash = "#/new";
      route();
      subscribeMyOrders();
      if (canSeeAdmin) loadAdminOrders();
    });

    /* ---------- tracking / counters ---------- */
    const branchCodes = { Riyadh: "RUH", Dammam: "DMM", Jeddah: "JED", Makkah: "MKK", Madina: "MED", HQ: "HQ" };
    const pad5 = (n) => String(n).padStart(5, "0");

    /* ---------- multi items UI ---------- */
    const itemsWrap = $("#itemsWrap");
    const addItemBtn = $("#addItemBtn");
    function makeItemRow(values = {}) {
      const row = document.createElement("div");
      row.className = "item-row";
      row.innerHTML = `
<input type="text" class="it-code" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù" value="${values.itemCode || ""}">
<input type="number" class="it-qty" min="1" step="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="${values.quantity || ""}">
<input type="number" class="it-price" min="0" step="0.01" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" value="${values.price || ""}">
<select class="it-ship" required>
<option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø´Ø­Ù†</option>
<option value="Sea freight">Sea freight</option>
<option value="DHL freight">DHL freight</option>
<option value="Air freight">Air freight</option>
</select>
<button type="button" class="remove">ğŸ—‘</button>`;
      row.querySelector(".remove").onclick = () => row.remove();
      return row;
    }
    function ensureAtLeastOneRow() { if (!itemsWrap.children.length) { itemsWrap.appendChild(makeItemRow()); } }
    addItemBtn.onclick = () => itemsWrap.appendChild(makeItemRow());

    /* ---------- links UI ---------- */
    const linksWrap = $("#linksWrap");
    const addLinkBtn = $("#addLinkBtn");
    function makeLinkRow(values = {}) {
      const r = document.createElement("div");
      r.className = "link-row";
      r.innerHTML = `
<input class="ln-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚ (Ù…Ø«Ø§Ù„: Ø¹Ø±Ø¶ Ø³Ø¹Ø±)" value="${values.name || ""}">
<input class="ln-url" placeholder="https://example.com/file.pdf" value="${values.url || ""}">
<button type="button" class="remove">ğŸ—‘</button>`;
      r.querySelector(".remove").onclick = () => { r.remove(); if (linksWrap.children.length < 3) addLinkBtn.disabled = false; };
      return r;
    }
    addLinkBtn.onclick = () => { if (linksWrap.children.length >= 3) return; linksWrap.appendChild(makeLinkRow()); if (linksWrap.children.length >= 3) addLinkBtn.disabled = true; };

    /* ---------- new order ---------- */
    const newMsg = $("#newMsg");
    const submitOrderBtn = $("#submitOrder");
    submitOrderBtn.addEventListener("click", async () => {
      hideMsg(newMsg);
      if (!currentUser || !userProfile) { showMsg(newMsg, "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", "error"); return; }

      const projectName = $("#projectName").value.trim();
      const customerName = $("#customerName").value.trim();

      const items = [...itemsWrap.querySelectorAll(".item-row")].map(r => ({
        itemCode: r.querySelector(".it-code").value.trim(),
        quantity: Number(r.querySelector(".it-qty").value),
        price: Number(r.querySelector(".it-price").value),
        shippingType: r.querySelector(".it-ship")?.value || "",
        status: r.querySelector(".it-status")?.value || "created",
        deliveredQty: Number(r.querySelector(".it-delivered")?.value || 0)
      })).filter(x => x.itemCode && x.shippingType && Number.isFinite(x.quantity) && x.quantity > 0 && Number.isFinite(x.price) && x.price >= 0);

      if (items.length === 0) { showMsg(newMsg, "Ø£Ø¶Ù ØµÙ†ÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.", "error"); return; }
      if (linksWrap.children.length > 3) { showMsg(newMsg, "Ù…Ø³Ù…ÙˆØ­ Ø¨Ø«Ù„Ø§Ø« Ù…Ø±ÙÙ‚Ø§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰.", "error"); return; }

      const attachments = [...linksWrap.querySelectorAll(".link-row")].map(r => {
        const name = (r.querySelector(".ln-name").value || "Ù…Ù„Ù").trim();
        const url = r.querySelector(".ln-url").value.trim();
        return url ? { name, url } : null;
      }).filter(Boolean);

      submitOrderBtn.classList.add("loading"); submitOrderBtn.disabled = true;

      try {
        const branch = userProfile.branch, code = branchCodes[branch] || "UNK";
        const counterRef = db.collection("counters").doc(branch);
        const seq = await db.runTransaction(async (tx) => { const s = await tx.get(counterRef); let next = 1; if (s.exists) next = (s.data().next || 1); tx.set(counterRef, { next: next + 1 }, { merge: true }); return next; });
        const tracking = code + pad5(seq);

        await db.collection("orders").doc(tracking).set({
          tracking, branch, projectName, customerName,
          items, attachments, createdBy: currentUser.uid,
          createdByEmail: currentUser.email || "",
          status: "created",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showMsg(newMsg, `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨. Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ù‘Ø¹: ${tracking}`, "success");
        $("#projectName").value = ""; $("#customerName").value = "";
        itemsWrap.innerHTML = ""; ensureAtLeastOneRow();
        linksWrap.innerHTML = ""; addLinkBtn.disabled = false;

        subscribeMyOrders(); if (canSeeAdmin) loadAdminOrders();

      } catch (err) {
        console.error(err); showMsg(newMsg, "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (err.message || err), "error");
      } finally {
        submitOrderBtn.classList.remove("loading"); submitOrderBtn.disabled = false;
      }
    });

    /* ---------- admin expandable orders ---------- */
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ±Ù‡ (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
    document.addEventListener("change", (e) => {
      const select = e.target.closest(".order-status-select");
      if (!select) return;

      const tr = select.closest("tr");
      const tracking = tr?.dataset?.tracking;
      const newStatus = select.value;

      if (!tracking || !newStatus) return;

      // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ ÙÙŠ adminRows (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      const order = adminRows.find(o => o.tracking === tracking);
      if (order) order.status = newStatus;

      // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ ØªÙ†ÙÙŠØ° Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ø§Ø­Ù‚Ø§Ù‹)
      console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ ${tracking} Ø¥Ù„Ù‰: ${newStatus}`);
    });

    document.addEventListener("click", (e) => {
      const toggleBtn = e.target.closest(".toggle-items");
      if (!toggleBtn) return;
      const tr = toggleBtn.closest("tr");
      const tracking = tr?.dataset?.tracking;
      const container = tr.nextElementSibling?.classList.contains("sub-items-row") ? tr.nextElementSibling : null;


      if (container) {
        container.hidden = !container.hidden;
        toggleBtn.textContent = container.hidden ? "ğŸ”½" : "ğŸ”¼";
      } else {
        const newRow = document.createElement("tr");
        newRow.className = "sub-items-row";
        newRow.innerHTML = `<td colspan="100%"><div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù...</div></td>`;
        tr.parentNode.insertBefore(newRow, tr.nextSibling);
        toggleBtn.textContent = "ğŸ”¼";


        const r = (Array.isArray(adminRows) && adminRows.find(x => x.tracking === tracking));
        if (r) {
          const inner = document.createElement("div");
          renderOrderItemsEdit(inner, r.items || [], tracking);
          newRow.innerHTML = `<td colspan="100%"></td>`;
          newRow.firstElementChild.appendChild(inner);
        } else {
          newRow.innerHTML = `<td colspan="100%"><div class="msg error">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù.</div></td>`;
        }
      }
    });

    /* ---------- table row renderer modification ---------- */
    function renderTableRow(r) {
      const createdAtStr = r.createdAt || "-";
      const userLabel = r.user || "-";
      const priceFirst = r.total;
      return `
<tr data-id="${r.tracking}">
<td>${r.tracking}</td>
<td>${createdAtStr}</td>
<td>${r.projectName || "-"}</td>
<td>${userLabel}</td>
<td>
<select class="status-dropdown" data-id="${r.tracking}">
<option value="created" ${r.status === 'created' ? 'selected' : ''}>Ø¬Ø¯ÙŠØ¯</option>
<option value="ordered" ${r.status === 'ordered' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…ØµÙ†Ø¹</option>
<option value="shipped" ${r.status === 'shipped' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
<option value="partial" ${r.status === 'partial' ? 'selected' : ''}>ÙˆØµÙ„Øª Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
<option value="delivered" ${r.status === 'delivered' ? 'selected' : ''}>ÙˆØµÙ„Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
</select>
</td>
<td>${(typeof priceFirst === "number") ? priceFirst.toFixed(2) : priceFirst}</td>
<td style="white-space: nowrap; text-align: left;">
<button type="button" class="toggle-items btn-sm" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„" style="margin-inline-end: 6px;">ğŸ”½</button>
<button type="button" class="btn-details btn-sm" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨" data-id="${r.tracking}">ğŸ–¨ï¸</button>
</td>
</tr>`;
    }

    /* ---------- MY ORDERS (Realtime) + details/print ---------- */

    function renderMyRow(r) {
      const createdAtStr = r.createdAt || "-";
      const priceFirst = r.total ?? "";

      return `
    <tr data-id="${r.tracking}">
      <td>${r.tracking}</td>
      <td>${createdAtStr}</td>
      <td>${r.projectName || "-"}</td>
      <td>${typeof priceFirst === "number" ? priceFirst.toFixed(2) : priceFirst}</td>
      <td>
        <button type="button" class="toggle-items btn-sm" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„" style="margin-inline-end:6px;">â–¾</button>
        <button type="button" class="btn-details btn-sm" title="Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨" data-id="${r.tracking}">ğŸ—‚ï¸</button>
      </td>
    </tr>
  `;
    }

    let myUnsub = null, myRows = [];
    function subscribeMyOrders() {
      if (myUnsub) { myUnsub(); myUnsub = null; }
      if (!currentUser) return;
      const q = db.collection("orders").where("createdBy", "==", currentUser.uid);
      myUnsub = q.onSnapshot((snap) => {
        myRows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        console.log('My Orders fetched:', myRows); // Debug log
        renderMy(myRows);
      },
        (err) => { console.error(err); showMsg(document.getElementById("newMsg"), "ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ: " + (err.message || err), "error"); });
    }
    const myTableBody = $("#myOrdersBody");
    function renderMy(rows) {
      // ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
      const selectedStatus = (myFilterStatus?.value || "").trim();
      if (selectedStatus) {
        rows = rows.filter(r => (r.status || "") === selectedStatus);
      }

      // Ø§Ù„Ø¨Ø­Ø«
      const term = (mySearch.value || "").trim().toLowerCase();
      rows = rows.filter(r => {
        if (!term) return true;
        const inTracking = (r.tracking || "").toLowerCase().includes(term);
        const inProj = (r.projectName || "").toLowerCase().includes(term);
        const inCust = (r.customerName || "").toLowerCase().includes(term);
        const inItems = (r.items || []).some(it => (it.itemCode || "").toLowerCase().includes(term));
        return inTracking || inProj || inCust || inItems;
      });

      // Ø§Ù„ØªØ±ØªÙŠØ¨
      rows.sort((a, b) => (mySort.value === "createdAt_desc"
        ? (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0)
        : (a.createdAt?.toMillis?.() || 0) - (b.createdAt?.toMillis?.() || 0)));

      // Ø§Ù„Ø¹Ø±Ø¶
      myTableBody.innerHTML = rows.map(r => {
        const items = r.items || [];
        const firstCode = items[0]?.itemCode || "";
        const extra = items.length > 1 ? ` (+${items.length - 1})` : "";
        const qtySum = items.reduce((s, x) => s + (x.quantity || 0), 0);
        const priceFirst = items.length ? (items[0].price ?? "") : "";
        const createdAtStr = fmtDate(r.createdAt, { withTime: true });

        return `
      <tr>
        <td><strong>${r.tracking}</strong></td>
        <td>${firstCode}${extra}</td>
        <td>${qtySum}</td>
        <td>${(typeof priceFirst === "number") ? priceFirst.toFixed(2) : priceFirst}</td>
        <td>${r.projectName || "-"}</td>
        <td><span class="status ${statusClass(r.status)}">${statusLabel(r.status)}</span></td>
        <td>${createdAtStr}</td>
        <td><button type="button" class="btn-strong" data-open="${r.tracking}" style="padding:6px 10px;border-radius:10px">ØªÙØ§ØµÙŠÙ„</button></td>
      </tr>`;
      }).join("");
    }
    //document.querySelectorAll('[data-open]').forEach(btn=>{ btn.onclick = ()=> openDetails(btn.dataset.open); });
    mySearch.addEventListener("input", () => renderMy(myRows));
    mySort.addEventListener("change", () => renderMy(myRows));
    myFilterStatus.addEventListener("change", () => renderMy(myRows));

    /* ---------- ADMIN (Ø¨Ø­Ø« Ù…ÙØ­Ø³Ù‘Ù† + Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„) ---------- */
    const adminBody = $("#adminOrdersBody"),
      adminSearch = $("#adminSearch"),
      adminFilterBranch = $("#adminFilterBranch"),
      adminFilterStatus = $("#adminFilterStatus"),
      adminFilterUser = $("#adminFilterUser"),
      adminSort = $("#adminSort");
    let usersById = {}; // uid -> {name, email, ...}

    let adminRows = [];
    async function loadAdminOrders() { // NEW
      if (!canSeeAdmin) return;

      const [ordersSnap, usersSnap] = await Promise.all([
        db.collection("orders").get(),
        db.collection("users").get()
      ]);

      usersById = {};
      usersSnap.forEach(d => usersById[d.id] = d.data() || {});

      adminRows = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      populateAdminUsers(adminRows);
      renderAdmin();
    }

    function populateAdminUsers(rows) { // NEW
      const map = new Map(); // uid -> label
      rows.forEach(r => {
        const uid = (r.createdBy || "").trim();
        if (!uid) return;
        const label = (usersById[uid]?.name || usersById[uid]?.email || uid);
        map.set(uid, label);
      });

      adminFilterUser.innerHTML =
        `<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>` +
        [...map.entries()]
          .sort((a, b) => a[1].localeCompare(b[1], 'ar'))
          .map(([uid, label]) => `<option value="${uid}">${label}</option>`)
          .join("");
    }

    function renderAdmin() { // NEW
      const term = (adminSearch.value || "").trim().toLowerCase();
      const fb = (adminFilterBranch.value || "");
      const fs = (adminFilterStatus.value || "");
      const fu = (adminFilterUser.value || ""); // â† UID
      const sort = (adminSort.value || "createdAt_desc");

      let rows = adminRows.filter(r => {
        if (fb && r.branch !== fb) return false;
        if (fs && (r.status || "") !== fs) return false;
        if (fu && (r.createdBy || "") !== fu) return false;

        if (!term) return true;
        const inTracking = (r.tracking || "").toLowerCase().includes(term);
        const inProj = (r.projectName || "").toLowerCase().includes(term);
        const inCust = (r.customerName || "").toLowerCase().includes(term);
        const inItems = (r.items || []).some(it => (it.itemCode || "").toLowerCase().includes(term));
        const inUserName = (usersById[r.createdBy]?.name || "").toLowerCase().includes(term);
        const inUserMail = (usersById[r.createdBy]?.email || "").toLowerCase().includes(term);
        return inTracking || inProj || inCust || inItems || inUserName || inUserMail;
      });

      rows.sort((a, b) => sort === "createdAt_desc"
        ? (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0)
        : (a.createdAt?.toMillis?.() || 0) - (b.createdAt?.toMillis?.() || 0));

      adminBody.innerHTML = rows.map(r => renderTableRow({
        ...r,
        user: usersById[r.createdBy]?.name || usersById[r.createdBy]?.email || r.createdBy,
        createdAt: fmtDate(r.createdAt),
        total: r.items?.[0]?.price ?? ""
      })).join("");


      adminSearch.addEventListener("input", renderAdmin);
      adminFilterBranch.addEventListener("change", renderAdmin);
      adminFilterStatus.addEventListener("change", renderAdmin);
      adminFilterUser.addEventListener("change", renderAdmin);
      adminSort.addEventListener("change", renderAdmin);

      // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ±Ù‡Ø§
      document.addEventListener("change", async (e) => {
        const select = e.target.closest(".order-status-select");
        if (!select) return;

        const tracking = select.dataset.tracking;
        const newStatus = select.value;

        if (!tracking || !newStatus) return;

        select.disabled = true;
        select.style.opacity = 0.6;

        try {
          await db.collection("orders").doc(tracking).update({ status: newStatus });

          const row = adminRows.find(r => r.tracking === tracking);
          if (row) row.status = newStatus;

          select.style.border = "2px solid #6c1d2c";
          setTimeout(() => {
            select.style.border = "";
          }, 1000);
        } catch (err) {
          alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: " + (err.message || err));
        } finally {
          select.disabled = false;
          select.style.opacity = 1;
        }
      });

      function statusLabel(s) { return { created: "Ø¬Ø¯ÙŠØ¯", ordered: "ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…ØµÙ†Ø¹", shipped: "ØªÙ… Ø§Ù„Ø´Ø­Ù†", delivered: "ÙˆØµÙ„Øª" }[s] || s; }
      function statusClass(s) { return { created: "s-created", ordered: "s-ordered", shipped: "s-shipped", delivered: "s-delivered" }[s] || "s-created"; }
    }


      // âœ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('[data-open], .btn-details');
        if (!btn) return;
        e.preventDefault();

        const tr = btn.closest('tr');
        const tracking =
          btn.dataset.open ||
          btn.dataset.id ||
          tr?.dataset.id ||
          tr?.cells?.[0]?.textContent?.trim();

        if (!tracking) {
          console.warn('Details: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ØªØªØ¨Ù‘Ø¹');
          return;
        }

        openDetails(tracking); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
      });

      // Ø¥ØºÙ„Ø§Ù‚/Ø·Ø¨Ø§Ø¹Ø© Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
      (function () {
        const modal = document.getElementById('detailsModal');
        const closeBtn = document.getElementById('closeDetails');
        const printBtn = document.getElementById('printDetailsBtn');

        closeBtn && (closeBtn.onclick = () => modal.classList.remove('show'));
        modal.querySelector('.backdrop')?.addEventListener('click', () => modal.classList.remove('show'));
        printBtn && (printBtn.onclick = () => window.print());
      })();
      // Ensure all opened blocks are closed
    </script>

</body>

</html>
