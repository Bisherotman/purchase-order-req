<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>بوابة طلبات الشراء | بيت الإباء</title>

<!-- خطوط -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --brand:#6c1d2c; --brand-600:#5f1926; --brand-500:#6c1d2c; --brand-400:#8a2a3b;
    --ink:#0f172a; --muted:#64748b; --bg:#fbf7f8; --card:#ffffff;
    --shadow:0 10px 30px rgba(108,29,44,.15); --radius:14px;

    /* تكبير الشعار ~40% (من ~57px إلى ~80px) */
    --logo-size: 80px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Tajawal","Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
  a{color:inherit;text-decoration:none}
  input,select,button{font-family:inherit}
  .container{max-width:1100px;margin:0 auto;padding:100px 16px 40px}

  /* Header */
  header{position:fixed;top:0;left:0;right:0;z-index:10;background:linear-gradient(180deg,#fff 0%,rgba(255,255,255,.96) 70%,rgba(255,255,255,.88) 100%);border-bottom:1px solid #f1e6e9;backdrop-filter:saturate(180%) blur(8px)}
  .nav{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:14px;padding:12px 16px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800}
  .brand img{width:var(--logo-size);height:var(--logo-size);object-fit:contain;filter:drop-shadow(0 4px 10px rgba(108,29,44,.25))}
  .brand span{color:var(--brand-500)}
  .navlinks{display:flex;align-items:center;gap:6px;margin-inline-start:auto}
  .navlinks a{padding:10px 14px;border-radius:999px;color:#2e1a1f;transition:transform .15s ease,background .2s ease,box-shadow .2s ease}
  .navlinks a.active,.navlinks a:hover{background:linear-gradient(180deg,#fde7ec,#f9eef1);box-shadow:inset 0 0 0 1px #f2cbd4}
  .navlinks .btn{background:linear-gradient(180deg,var(--brand-400),var(--brand-500));color:#fff;box-shadow:0 6px 16px rgba(108,29,44,.25);font-weight:700}
  .navlinks .btn:hover{transform:translateY(-1px);filter:saturate(110%)} .navlinks .btn:active{transform:translateY(0);filter:saturate(120%)}

  /* Cards / forms */
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin:18px 0}
  h1,h2{margin:0 0 10px} h2{font-size:22px}
  label{font-weight:700;display:block;margin-top:10px}
  input,select,button{width:100%;padding:12px 14px;margin-top:8px;border-radius:12px;border:1px solid #f0dbe0;background:#fff;font-size:16px}
  input:focus,select:focus{outline:0;border-color:#e3b3bd;box-shadow:0 0 0 3px #f6d7de}
  button{background:linear-gradient(180deg,var(--brand-400),var(--brand-500));color:#fff;border:0;cursor:pointer;transition:transform .1s ease,filter .15s ease}
  button:hover{transform:translateY(-1px);filter:saturate(115%)}
  .btn-strong{font-weight:800;letter-spacing:.2px;position:relative;overflow:hidden}
  .btn-strong.loading{opacity:.85;pointer-events:none}
  .btn-strong.loading::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);animation:shimmer 1.2s infinite}
  @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

  .row{display:flex;gap:12px;align-items:center}.row>*{flex:1}
  .msg{margin-top:12px;padding:12px;border-radius:12px;display:none}
  .msg.success{background:#f2fbf5;color:#14532d;border:1px solid #c7f0d2}
  .msg.error{background:#fef2f2;color:#7f1d1d;border:1px solid #fecaca}
  .helper{color:var(--muted);font-size:13px;margin-top:6px}

  /* Sections (تطبق فقط على معلومات المشروع والأصناف) */
  .section-box{margin:14px 0 8px;text-align:center;font-weight:800;padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,#fff,#f7eef0);color:#3b121b;border:1px solid #f0dbe0}

  /* Table */
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{font-size:13px;color:var(--muted);text-align:right}
  tbody tr{background:#fff;box-shadow:var(--shadow)}
  td,th{padding:12px 14px}
  tbody tr td:first-child{border-radius:12px 0 0 12px}
  tbody tr td:last-child{border-radius:0 12px 12px 0}
  .status{padding:6px 10px;border-radius:999px;font-size:12px}
  .s-created{background:#f3e8ff;color:#6b21a8}
  .s-ordered{background:#fff1f2;color:#9f1239}
  .s-shipped{background:#eff6ff;color:#1d4ed8}
  .s-delivered{background:#ecfdf5;color:#065f46}

  /* Items + Links rows */
  .items-head{display:flex;align-items:center;justify-content:center;margin-top:8px}
  .item-row{display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:10px;margin-top:8px}
  .item-row .remove{background:#fff;border:1px solid #f0dbe0;color:#b91c1c}
  .add-item{margin-top:10px;background:#fff;color:var(--brand);border:1px dashed #e3b3bd}
  .add-item:hover{background:#fdf2f4}

  .link-row{display:grid;grid-template-columns:1.3fr 2.2fr auto;gap:10px;margin-top:8px}
  .link-row .remove{background:#fff;border:1px solid #f0dbe0;color:#b91c1c}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
  .modal.show{display:flex}
  .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
  .modal-card{position:relative;background:#fff;width:min(720px,92vw);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:18px}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .close-x{background:#fff;border:1px solid #eee;color:#444;width:36px;height:36px;border-radius:10px}
  .t-small{font-size:13px;color:#475569}
  .table-like{width:100%;border-collapse:collapse}
  .table-like th,.table-like td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:right}
  .table-like thead th{color:#64748b;font-size:13px}
  .total{font-weight:800}

  @media (max-width:720px){.item-row{grid-template-columns:1fr 1fr 1fr auto}}
  @media (max-width:640px){:root{--logo-size:64px}}
  @media print{
    header,.view:not(.printable),.modal .close-x,.modal .backdrop{display:none !important}
    .modal-card{box-shadow:none;width:auto;padding:0}
  }
</style>
</head>
<body>

<header>
  <nav class="nav">
    <a class="brand" href="#/login" id="brandLink">
      <img src="img/pagelogo.png" alt="Bayt Alebaa Logo" />
      <span>بوابة طلبات الشراء لقسم المشاريع</span>
    </a>
    <div class="navlinks" id="navLinks">
      <a href="#/new"   data-auth="user"  style="display:none">طلب جديد</a>
      <a href="#/my"    data-auth="user"  style="display:none">طلبــاتي</a>
      <a href="#/admin" data-auth="admin" style="display:none">إدارة الطلبات</a>
      <a href="#/login" id="sessionBtn" class="btn">دخول</a>
    </div>
  </nav>
</header>

<div class="container">

  <!-- LOGIN -->
  <section id="view-login" class="view active">
    <div class="card">
      <h2>تسجيل الدخول</h2>
      <form id="loginForm">
        <label for="loginEmail">الإيميل</label>
        <input id="loginEmail" type="email" required placeholder="example@company.com" />
        <div class="row" style="align-items:center">
          <div style="flex:1">
            <label for="loginPassword">كلمة المرور</label>
            <input id="loginPassword" type="password" required placeholder="••••••••" />
          </div>
          <label style="display:flex;gap:8px;align-items:center;margin-top:28px">
            <input id="rememberEmail" type="checkbox" /> <span class="helper">تذكّر الإيميل</span>
          </label>
        </div>
        <button type="submit" id="loginBtn" class="btn-strong">دخول</button>
        <div id="loginMsg" class="msg"></div>
        <div class="helper">* إنشاء الحسابات يتم عبر الإدارة فقط.</div>
      </form>
    </div>
  </section>

  <!-- NEW ORDER -->
  <section id="view-new" class="view">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>تسجيل طلب شراء</h2>
        <div class="helper" id="whoami">—</div>
      </div>

      <div class="section-box">معلومات المشروع</div>
      <div class="row">
        <div><label for="projectName">اسم المشروع</label><input id="projectName" type="text" placeholder="مشروع أبراج..." /></div>
        <div><label for="customerName">اسم العميل/الجهة</label><input id="customerName" type="text" placeholder="شركة/جهة..." /></div>
      </div>

      <div class="section-box">الأصناف</div>
      <div class="items-head"><button type="button" id="addItemBtn" class="add-item">+ إضافة صنف</button></div>
      <div id="itemsWrap"></div>

      <label style="font-weight:700; display:block; margin-top:14px">
        روابط المرفقات (اختياري — حد أقصى 2)
      </label>
      <div id="linksWrap"></div>
      <button type="button" id="addLinkBtn" class="add-item">+ إضافة رابط</button>

      <button type="button" id="submitOrder" class="btn-strong">إرسال الطلب</button>
      <div id="newMsg" class="msg"></div>
    </div>
  </section>

  <!-- MY ORDERS -->
  <section id="view-my" class="view">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>طلبــاتي</h2>
        <div class="helper" id="whoamiMy">—</div>
      </div>
      <div class="row">
        <input id="mySearch" placeholder="ابحث برقم التتبّع أو كود الصنف" />
        <select id="mySort">
          <option value="createdAt_desc">الأحدث أولاً</option>
          <option value="createdAt_asc">الأقدم أولاً</option>
        </select>
      </div>
      <div id="myTableWrap" class="card" style="padding:0">
        <table>
          <thead>
            <tr>
              <th>التتبّع</th><th>الصنف</th><th>الكمية</th><th>السعر</th><th>المشروع</th><th>الحالة</th><th>التاريخ</th><th>تفاصيل</th>
            </tr>
          </thead>
          <tbody id="myOrdersBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="view-admin" class="view">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>إدارة الطلبات</h2>
        <div class="helper" id="whoamiAdmin">—</div>
      </div>
      <div class="row">
        <input id="adminSearch" placeholder="ابحث برقم التتبّع أو كود الصنف" />
        <select id="adminFilterBranch">
          <option value="">كل الفروع</option>
          <option>Riyadh</option><option>Dammam</option><option>Jeddah</option>
          <option>Makkah</option><option>Madina</option><option>HQ</option>
        </select>
      </div>
      <div id="adminTableWrap" class="card" style="padding:0">
        <table>
          <thead>
            <tr>
              <th>الفرع</th><th>التتبّع</th><th>الصنف</th><th>الكمية</th><th>السعر</th><th>المشروع</th><th>الحالة</th><th>إجراء</th>
            </tr>
          </thead>
          <tbody id="adminOrdersBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- DETAILS MODAL (عرض/طباعة فقط) -->
<div id="detailsModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="modal-card printable">
    <div class="modal-header">
      <h3 style="margin:0">تفاصيل الطلب</h3>
      <div style="display:flex; gap:8px">
        <button class="btn-strong" id="printDetailsBtn" style="padding:8px 12px;border-radius:10px">طباعة</button>
        <button class="close-x" id="closeDetails">✕</button>
      </div>
    </div>
    <div id="detailsBody" class="t-small"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

<script>
/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "XXXXXXXXXXXX",
  appId: "1:XXXXXXXXXXXX:web:XXXXXXXXXXXXXX"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ---------- helpers / routing ---------- */
const $ = (s)=>document.querySelector(s);
const navLinks = $("#navLinks");
const sessionBtn = $("#sessionBtn");
const routes = { "#/login":"view-login", "#/new":"view-new", "#/my":"view-my", "#/admin":"view-admin" };

function setActive(hash){ navLinks.querySelectorAll("a").forEach(a=>a.classList.toggle("active", a.getAttribute("href")==hash)); }
function showMsg(el, text, type="success"){ el.textContent=text; el.className="msg "+type; el.style.display="block"; }
function hideMsg(el){ el.style.display="none"; }
function showView(id){ document.querySelectorAll(".view").forEach(v=>v.classList.remove("active")); const el=document.getElementById(id); el.classList.add("active"); window.scrollTo({top:0,behavior:"smooth"}); }
function route(){ const h=location.hash||"#/login"; setActive(h); if(!currentUser && h!=="#/login"){ location.hash="#/login"; return; } if(!canSeeAdmin && h==="#/admin"){ location.hash="#/new"; return; } showView(routes[h]); }
window.addEventListener("hashchange", route);

/* ---------- state ---------- */
const loginForm=$("#loginForm"), loginMsg=$("#loginMsg"), loginBtn=$("#loginBtn");
const whoami=$("#whoami"), whoamiMy=$("#whoamiMy"), whoamiAdmin=$("#whoamiAdmin");
let currentUser=null, userProfile=null, canSeeAdmin=false;

/* ---------- remember email ---------- */
const rememberCk = $("#rememberEmail");
const savedEmail = localStorage.getItem("savedEmail");
if(savedEmail){ $("#loginEmail").value = savedEmail; rememberCk.checked = true; }

/* ---------- MY ORDERS elements ---------- */
const myBody = $("#myOrdersBody"), mySearch = $("#mySearch"), mySort = $("#mySort");

/* ---------- auth ---------- */
loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault(); hideMsg(loginMsg);
  loginBtn.classList.add("loading");
  const email=$("#loginEmail").value.trim(), pass=$("#loginPassword").value;
  try{
    await auth.signInWithEmailAndPassword(email,pass);
    if(rememberCk.checked) localStorage.setItem("savedEmail", email);
    else localStorage.removeItem("savedEmail");
    showMsg(loginMsg,"تم تسجيل الدخول.","success");
  }catch(err){
    showMsg(loginMsg,"خطأ: "+(err.message||err),"error");
  }finally{
    loginBtn.classList.remove("loading");
  }
});
sessionBtn.addEventListener("click",(e)=>{ if(currentUser){ e.preventDefault(); auth.signOut(); } });

function displayNameOrEmail(u, profile){
  return (profile && profile.name) ? profile.name : (u.displayName || u.email);
}

auth.onAuthStateChanged(async (user)=>{
  currentUser=user;
  if(!user){
    userProfile=null; canSeeAdmin=false;
    navLinks.querySelectorAll("[data-auth]").forEach(a=>a.style.display="none");
    sessionBtn.textContent="دخول"; sessionBtn.setAttribute("href","#/login");
    if (myUnsub) { myUnsub(); myUnsub=null; }
    location.hash="#/login"; route();
    return;
  }
  const snap=await db.collection("users").doc(user.uid).get();
  if(!snap.exists){ showMsg(loginMsg,"حسابك غير مهيأ. تواصل مع الإدارة لإسناد فرع لك.","error"); await auth.signOut(); return; }
  userProfile=snap.data(); canSeeAdmin=!!userProfile.isAdmin || userProfile.branch==="HQ";

  const badge=`مرحباً، ${displayNameOrEmail(user,userProfile)} — الفرع: ${userProfile.branch}${canSeeAdmin?' — إدارة':''}`;
  whoami.textContent=badge; whoamiMy.textContent=badge; whoamiAdmin.textContent=badge;

  navLinks.querySelectorAll("[data-auth]").forEach(a=>{
    const t=a.dataset.auth; a.style.display=(t==="user")? "" : (canSeeAdmin? "" : "none");
  });
  sessionBtn.textContent="خروج"; sessionBtn.setAttribute("href","#/login");

  if(location.hash==="#/login"){ location.hash="#/new"; }
  route();
  subscribeMyOrders();
  if(canSeeAdmin) loadAdminOrders();
});

/* ---------- tracking / counters ---------- */
const branchCodes={Riyadh:"RUH",Dammam:"DMM",Jeddah:"JED",Makkah:"MKK",Madina:"MED",HQ:"HQ"};
const pad5=(n)=>String(n).padStart(5,"0");

/* ---------- multi items UI ---------- */
const itemsWrap = $("#itemsWrap");
const addItemBtn = $("#addItemBtn");
function makeItemRow(values={}){
  const row=document.createElement("div");
  row.className="item-row";
  row.innerHTML = `
    <input type="text" class="it-code" placeholder="كود الصنف" value="${values.itemCode||""}">
    <input type="number" class="it-qty"  min="1" step="1" placeholder="الكمية" value="${values.quantity||""}">
    <input type="number" class="it-price" min="0" step="0.01" placeholder="سعر البيع" value="${values.price||""}">
    <button type="button" class="remove">🗑</button>
  `;
  row.querySelector(".remove").onclick=()=> row.remove();
  return row;
}
function ensureAtLeastOneRow(){ if(!itemsWrap.children.length){ itemsWrap.appendChild(makeItemRow()); } }
addItemBtn.onclick = ()=> itemsWrap.appendChild(makeItemRow());
ensureAtLeastOneRow();

/* ---------- links UI (URLs only, max 2) ---------- */
const linksWrap = $("#linksWrap");
const addLinkBtn = $("#addLinkBtn");
function makeLinkRow(values={}){
  const r=document.createElement("div");
  r.className="link-row";
  r.innerHTML=`
    <input class="ln-name" placeholder="اسم المرفق (مثال: عرض سعر)" value="${values.name||""}">
    <input class="ln-url"  placeholder="https://example.com/file.pdf" value="${values.url||""}">
    <button type="button" class="remove">🗑</button>
  `;
  r.querySelector(".remove").onclick=()=>{
    r.remove();
    if(linksWrap.children.length < 2) addLinkBtn.disabled = false;
  };
  return r;
}
addLinkBtn.onclick = ()=>{
  if (linksWrap.children.length >= 2) return;
  linksWrap.appendChild(makeLinkRow());
  if (linksWrap.children.length >= 2) addLinkBtn.disabled = true;
};

/* ---------- new order ---------- */
const newMsg=$("#newMsg");
const submitOrderBtn = $("#submitOrder");
submitOrderBtn.addEventListener("click", async ()=>{
  hideMsg(newMsg);
  if(!currentUser || !userProfile){ showMsg(newMsg,"يجب تسجيل الدخول أولاً.","error"); return; }

  const projectName = $("#projectName").value.trim();
  const customerName= $("#customerName").value.trim();

  const items = [...itemsWrap.querySelectorAll(".item-row")].map(r=>({
    itemCode: r.querySelector(".it-code").value.trim(),
    quantity: Number(r.querySelector(".it-qty").value),
    price:    Number(r.querySelector(".it-price").value)
  })).filter(x=>x.itemCode && Number.isFinite(x.quantity) && x.quantity>0 && Number.isFinite(x.price) && x.price>=0);

  if(items.length===0){ showMsg(newMsg,"أضف صنفًا واحدًا على الأقل بشكل صحيح.","error"); return; }

  if (linksWrap.children.length > 2) {
    showMsg(newMsg, "مسموح بمرفقين كحد أقصى.", "error");
    return;
  }

  const attachments = [...linksWrap.querySelectorAll(".link-row")].map(r=>{
    const name=(r.querySelector(".ln-name").value||"ملف").trim();
    const url = r.querySelector(".ln-url").value.trim();
    return url ? {name, url} : null;
  }).filter(Boolean);

  submitOrderBtn.classList.add("loading"); submitOrderBtn.disabled=true;

  try{
    const branch=userProfile.branch, code=branchCodes[branch]||"UNK";
    const counterRef=db.collection("counters").doc(branch);
    const seq=await db.runTransaction(async(tx)=>{ const s=await tx.get(counterRef); let next=1; if(s.exists) next=(s.data().next||1); tx.set(counterRef,{next:next+1},{merge:true}); return next; });
    const tracking=code+pad5(seq);

    await db.collection("orders").doc(tracking).set({
      tracking, branch, projectName, customerName,
      items, attachments,                // روابط فقط
      createdBy: currentUser.uid, status:"created",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showMsg(newMsg,`تم تسجيل الطلب. رقم التتبّع: ${tracking}`,"success");
    // reset
    $("#projectName").value=""; $("#customerName").value="";
    itemsWrap.innerHTML=""; ensureAtLeastOneRow();
    linksWrap.innerHTML=""; addLinkBtn.disabled=false;

    subscribeMyOrders(); if(canSeeAdmin) loadAdminOrders();

  }catch(err){
    console.error(err); showMsg(newMsg,"خطأ أثناء الإرسال: "+(err.message||err),"error");
  }finally{
    submitOrderBtn.classList.remove("loading"); submitOrderBtn.disabled=false;
  }
});

/* ---------- MY ORDERS (Realtime) + details/print ---------- */
let myUnsub=null, myRows=[];
function subscribeMyOrders(){
  if(myUnsub){ myUnsub(); myUnsub=null; }
  if(!currentUser) return;
  const q=db.collection("orders").where("createdBy","==",currentUser.uid);
  myUnsub=q.onSnapshot((snap)=>{
    myRows=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderMy(myRows);
  },(err)=>{ console.error(err); showMsg(document.getElementById("newMsg"),"تعذّر تحميل طلباتك: "+(err.message||err),"error"); });
}
function renderMy(rows){
  const term=(mySearch.value||"").toLowerCase();
  rows=rows.filter(r=>{
    const first=(r.items?.[0]?.itemCode||"").toLowerCase();
    return !term || r.tracking.toLowerCase().includes(term) || first.includes(term);
  });
  rows.sort((a,b)=> (mySort.value==="createdAt_desc"
    ? (b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0)
    : (a.createdAt?.toMillis?.()||0)-(b.createdAt?.toMillis?.()||0)));

  myBody.innerHTML=rows.map(r=>{
    const items=r.items||[];
    const firstCode = items[0]?.itemCode || "";
    const extra = items.length>1 ? ` (+${items.length-1})` : "";
    const qtySum = items.reduce((s,x)=>s+(x.quantity||0),0);
    const priceFirst = items.length ? (items[0].price ?? "") : "";
    return `
      <tr>
        <td><strong>${r.tracking}</strong></td>
        <td>${firstCode}${extra}</td>
        <td>${qtySum}</td>
        <td>${(typeof priceFirst==="number") ? priceFirst.toFixed(2) : priceFirst}</td>
        <td>${r.projectName||"-"}</td>
        <td><span class="status ${statusClass(r.status)}">${statusLabel(r.status)}</span></td>
        <td>${r.createdAt?.toDate?.().toLocaleString('ar-SA')||""}</td>
        <td><button type="button" class="btn-strong" data-open="${r.tracking}" style="padding:6px 10px;border-radius:10px">تفاصيل</button></td>
      </tr>`;
  }).join("");

  document.querySelectorAll('[data-open]').forEach(btn=>{ btn.onclick = ()=> openDetails(btn.dataset.open); });
}
mySearch.addEventListener("input",()=>renderMy(myRows));
mySort.addEventListener("change",()=>renderMy(myRows));

/* تفاصيل + طباعة فقط */
const modal=$("#detailsModal"), closeDetails=$("#closeDetails"), detailsBody=$("#detailsBody"), printBtn=$("#printDetailsBtn");
function openDetails(tracking){
  const r = myRows.find(x=>x.tracking===tracking);
  if(!r) return;

  const items=r.items||[];
  const qtySum=items.reduce((s,x)=>s+(x.quantity||0),0);
  const rows=items.map((it,i)=>`
    <tr><td>${i+1}</td><td>${it.itemCode||""}</td><td>${it.quantity??""}</td><td>${(typeof it.price==="number")?it.price.toFixed(2):it.price??""}</td></tr>
  `).join("");

  const attachHtml = (r.attachments?.length)
    ? `<ul>${r.attachments.map(a=>`<li><a href="${a.url}" target="_blank">${a.name}</a></li>`).join("")}</ul>`
    : `<div class="muted">لا توجد مرفقات.</div>`;

  detailsBody.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <img src="img/pagelogo.png" alt="logo" style="width:48px;height:48px;object-fit:contain">
      <div>
        <div><b>رقم التتبّع:</b> ${r.tracking}</div>
        <div class="muted">الفرع: <b>${r.branch}</b> — أنشئ بواسطة: <b>${displayNameOrEmail(currentUser,userProfile)}</b></div>
      </div>
    </div>
    <div style="margin:8px 0 4px"><b>المشروع:</b> ${r.projectName||"-"} &nbsp; | &nbsp; <b>العميل/الجهة:</b> ${r.customerName||"-"}</div>
    <table class="table-like" style="margin-top:8px">
      <thead><tr><th>#</th><th>كود الصنف</th><th>الكمية</th><th>سعر البيع</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><td colspan="2" class="total">الإجمالي</td><td class="total">${qtySum}</td><td></td></tr></tfoot>
    </table>
    <div style="margin-top:10px">
      <b>المرفقات:</b>
      ${attachHtml}
    </div>
  `;
  modal.classList.add("show");
}
closeDetails.onclick = ()=> modal.classList.remove("show");
modal.querySelector(".backdrop").onclick = ()=> modal.classList.remove("show");
printBtn.onclick = ()=> window.print();

/* ---------- ADMIN ---------- */
const adminBody=$("#adminOrdersBody"), adminSearch=$("#adminSearch"), adminFilterBranch=$("#adminFilterBranch");
async function loadAdminOrders(){
  if(!canSeeAdmin) return;
  const snap=await db.collection("orders").get();
  let rows=snap.docs.map(d=>({id:d.id,...d.data()}));
  renderAdmin(rows);
}
function renderAdmin(rows){
  const term=(adminSearch.value||"").toLowerCase(), fb=adminFilterBranch.value;
  rows=rows.filter(r=>{
    const first=(r.items?.[0]?.itemCode||"").toLowerCase();
    return (!fb || r.branch===fb) && (!term || r.tracking.toLowerCase().includes(term) || first.includes(term));
  });
  rows.sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
  adminBody.innerHTML=rows.map(r=>{
    const items=r.items||[];
    const firstCode=items[0]?.itemCode || "";
    const extra=items.length>1 ? ` (+${items.length-1})` : "";
    const qtySum=items.reduce((s,x)=>s+(x.quantity||0),0);
    const priceFirst=items.length ? (items[0].price ?? "") : "";
    return `
      <tr>
        <td>${r.branch}</td>
        <td><strong>${r.tracking}</strong></td>
        <td>${firstCode}${extra}</td>
        <td>${qtySum}</td>
        <td>${(typeof priceFirst==="number") ? priceFirst.toFixed(2) : priceFirst}</td>
        <td>${r.projectName||"-"}</td>
        <td><span class="status ${statusClass(r.status)}">${statusLabel(r.status)}</span></td>
        <td>
          <select data-id="${r.tracking}" class="updStatus">
            ${["created","ordered","shipped","delivered"].map(s=>`<option value="${s}" ${r.status===s?"selected":""}>${statusLabel(s)}</option>`).join("")}
          </select>
        </td>
      </tr>`;
  }).join("");

  document.querySelectorAll(".updStatus").forEach(sel=>{
    sel.onchange=async(e)=>{
      const id=e.target.dataset.id, val=e.target.value;
      await db.collection("orders").doc(id).update({status:val});
      loadAdminOrders(); subscribeMyOrders();
    };
  });
}
adminSearch.addEventListener("input",()=>loadAdminOrders());
adminFilterBranch.addEventListener("change",()=>loadAdminOrders());

function statusLabel(s){ return {created:"جديد",ordered:"تم الطلب من المصنع",shipped:"تم الشحن",delivered:"وصلت"}[s] || s; }
function statusClass(s){ return {created:"s-created",ordered:"s-ordered",shipped:"s-shipped",delivered:"s-delivered"}[s] || "s-created"; }

/* ---------- init ---------- */
route();
</script>
</body>
</html>